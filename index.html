import React, { useState, useEffect, useRef } from 'react';
import { Home, Calculator, Box, Plus, Trash2, FileText, X, ChevronDown, ChevronUp, Download, Image as ImageIcon, CheckSquare, AlertCircle, Settings, Lock, Save, LogOut, RotateCcw } from 'lucide-react';

// --- Helper Functions ---
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(amount);
};

const generateId = () => Math.random().toString(36).substr(2, 9);

// --- Configuration Types ---
type AppConfig = {
  hardwarePrice: number;      // ราคาอุปกรณ์ภายนอก (เดิม 1956)
  topRailPrice: number;       // ราคารางบนต่อเมตร (เดิม 200)
  bottomRailPrice: number;    // ราคารางล่างต่อเมตร (เดิม 150)
  slingPrice: number;         // ราคาสลิงต่อเมตร (เดิม 138)
  fabricFactor: number;       // ตัวคูณสูตรผ้า (เดิม 1.2)
  basswoodPrice: number;      // ราคา BASSWOOD (789)
  fauxwoodPrice: number;      // ราคา FAUX WOOD (750)
};

const DEFAULT_CONFIG: AppConfig = {
  hardwarePrice: 1956,
  topRailPrice: 200,
  bottomRailPrice: 150,
  slingPrice: 138,
  fabricFactor: 1.2,
  basswoodPrice: 789,
  fauxwoodPrice: 750,
};

// --- Types ---
type CalculatorItem = {
  id: string;
  type: 'external' | 'internal' | 'wooden';
  typeName: string;
  woodType?: string; // For wooden blinds
  w_cm: number;
  h_cm: number;
  w_m: number;
  h_m: number;
  unitPrice: number;
  qty: number;
  side: string;
  totalPerUnit: number;
  grandTotal: number;
  details: {
    fabricFormula?: string;
    topRailFormula?: string;
    bottomRailFormula?: string;
    slingFormula?: string;
    hardwarePrice?: number;
    sumFormula?: string;
    mainFormula?: string;
  };
};

export default function App() {
  const [activeTab, setActiveTab] = useState('calculator');
  const [libsLoaded, setLibsLoaded] = useState(false);
  
  // Config State (Load from localStorage if available)
  const [config, setConfig] = useState<AppConfig>(() => {
    const saved = localStorage.getItem('blindAppConfig');
    return saved ? JSON.parse(saved) : DEFAULT_CONFIG;
  });

  // Admin State
  const [showAdmin, setShowAdmin] = useState(false);
  const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);

  // Save config to localStorage whenever it changes
  useEffect(() => {
    localStorage.setItem('blindAppConfig', JSON.stringify(config));
  }, [config]);

  // Load external libraries for PDF/Image export
  useEffect(() => {
    const loadScript = (src: string) => {
      return new Promise<void>((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = reject;
        document.body.appendChild(script);
      });
    };

    Promise.all([
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'),
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')
    ]).then(() => {
      setLibsLoaded(true);
      console.log('Export libraries loaded');
    }).catch(err => console.error('Failed to load libraries', err));
  }, []);

  const handleAdminAccess = () => {
    if (isAdminLoggedIn) {
      setShowAdmin(true);
    } else {
      setShowAdmin(true); // Will show login screen inside modal
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans pb-24 text-slate-800" style={{ fontFamily: "'Sarabun', sans-serif" }}>
      {/* Inject Font */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        .printable-content { background: white; color: black; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Hide scrollbar for cleaner UI */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
      `}</style>

      {/* Main Content Area */}
      <div className="max-w-md mx-auto min-h-screen relative bg-white sm:shadow-xl sm:my-4 sm:rounded-[30px] sm:min-h-[calc(100vh-2rem)] overflow-hidden">
        
        {/* Header/Status Bar */}
        <div className="h-14 bg-white/95 backdrop-blur-sm w-full absolute top-0 z-30 flex justify-between items-center px-4 shadow-sm border-b border-slate-50">
            <div className="flex items-center gap-2">
                {/* Small Logo for Header */}
                <h1 className="text-3xl font-black text-red-600 italic tracking-tighter select-none" style={{ fontFamily: 'Arial, Helvetica, sans-serif', transform: 'skew(-5deg)' }}>
                  SUNNY
                </h1>
            </div>
        </div>

        {activeTab === 'home' && <HomePage setActiveTab={setActiveTab} />}
        {activeTab === 'stock' && <StockPage />}
        {activeTab === 'calculator' && <CalculatorPage libsLoaded={libsLoaded} config={config} />}

        {/* Bottom Navigation - Fixed Position */}
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] max-w-[400px] bg-white/90 backdrop-blur-lg shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-2xl p-2 flex justify-around items-center border border-gray-100 z-50">
           <NavButton 
              active={activeTab === 'home'} 
              onClick={() => setActiveTab('home')} 
              icon={<Home size={24} />} 
              label="หน้าหลัก" 
           />
           <NavButton 
              active={activeTab === 'stock'} 
              onClick={() => setActiveTab('stock')} 
              icon={<CheckSquare size={24} />} 
              label="เช็คสต็อก" 
           />
           <NavButton 
              active={activeTab === 'calculator'} 
              onClick={() => setActiveTab('calculator')} 
              icon={<Calculator size={24} />} 
              label="คำนวณราคา" 
           />
           <NavButton 
              active={showAdmin} 
              onClick={handleAdminAccess} 
              icon={<Settings size={24} />} 
              label="ตั้งค่า" 
           />
        </div>

        {/* Admin Modal */}
        {showAdmin && (
            <AdminModal 
                isOpen={showAdmin} 
                onClose={() => setShowAdmin(false)} 
                isLoggedIn={isAdminLoggedIn} 
                setLoggedIn={setIsAdminLoggedIn}
                config={config}
                setConfig={setConfig}
            />
        )}
      </div>
    </div>
  );
}

const NavButton = ({ active, onClick, icon, label }: any) => (
  <button 
    onClick={onClick}
    className={`flex flex-col items-center p-2 rounded-xl transition-all duration-300 w-20 ${active ? 'text-blue-600 bg-blue-50 translate-y-[-4px] shadow-sm' : 'text-gray-400 hover:text-gray-600'}`}
  >
    {icon}
    <span className="text-[10px] mt-1 font-bold">{label}</span>
  </button>
);

// --- Pages ---

const HomePage = ({ setActiveTab }: { setActiveTab: (t: string) => void }) => (
  <div className="flex flex-col items-center justify-center h-full pt-32 p-6 text-center fade-in pb-32">
    {/* Large Logo for Home Page */}
    <h1 className="text-7xl font-black text-red-600 italic tracking-tighter mb-6 select-none drop-shadow-md" style={{ fontFamily: 'Arial, Helvetica, sans-serif', transform: 'skew(-5deg)' }}>
      SUNNY
    </h1>
    
    <h2 className="text-2xl font-bold text-gray-800 mb-2">ระบบร้านม่านม้วน</h2>
    <p className="text-gray-500 mb-8 max-w-xs leading-relaxed text-sm">
      จัดการสต็อก คำนวณราคา และออกใบเสนอราคาได้ง่ายๆ ในที่เดียว
    </p>
    <button 
      onClick={() => setActiveTab('calculator')}
      className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center gap-2"
    >
      เริ่มคำนวณราคา <Calculator size={18} />
    </button>
  </div>
);

const StockPage = () => (
  <div className="flex flex-col items-center justify-center h-full pt-40 p-6 text-center fade-in pb-32">
    <div className="w-24 h-24 bg-orange-50 rounded-full flex items-center justify-center mb-6 ring-4 ring-white">
      <Box size={48} className="text-orange-500" />
    </div>
    <h1 className="text-xl font-bold text-gray-800 mb-2">เช็คสต็อกสินค้า</h1>
    <p className="text-gray-400 text-sm mb-6">ฟีเจอร์นี้กำลังอยู่ระหว่างการพัฒนา</p>
    <div className="w-full max-w-[200px] bg-gray-100 rounded-full h-2">
      <div className="bg-orange-400 h-2 rounded-full w-[70%]"></div>
    </div>
    <p className="text-xs text-orange-400 mt-2 font-medium">Coming Soon (70%)</p>
  </div>
);

const CalculatorPage = ({ libsLoaded, config }: { libsLoaded: boolean, config: AppConfig }) => {
  const [calcMode, setCalcMode] = useState<'external' | 'internal' | 'wooden'>('external');
  const [items, setItems] = useState<CalculatorItem[]>([]);
  const [showQuote, setShowQuote] = useState(false);
  const [errorMsg, setErrorMsg] = useState('');
  
  const [formData, setFormData] = useState({
    width: '',
    height: '',
    price: '',
    qty: '1',
    side: 'ขวา',
    woodType: 'BASSWOOD' as 'BASSWOOD' | 'FAUX WOOD'
  });

  // Clear error when typing
  useEffect(() => {
    if (errorMsg) setErrorMsg('');
  }, [formData]);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const calculateItem = () => {
    const w_cm = parseFloat(formData.width);
    const h_cm = parseFloat(formData.height);
    const qty = parseInt(formData.qty);
    
    // Determine Price
    let price = 0;
    if (calcMode === 'wooden') {
      price = formData.woodType === 'BASSWOOD' ? config.basswoodPrice : config.fauxwoodPrice;
    } else {
      price = parseFloat(formData.price);
    }
    
    if (!w_cm || !h_cm || !price || !qty) {
      setErrorMsg('กรุณากรอกข้อมูลให้ครบถ้วน');
      return;
    }

    const w_m = w_cm / 100;
    const h_m = h_cm / 100;
    let result: CalculatorItem;
    
    // Common Base: Area * Factor * Price
    const baseFactor = calcMode === 'wooden' ? 1.2 : config.fabricFactor;
    const fabricCostPerUnit = w_m * h_m * baseFactor * price; 

    if (calcMode === 'external') {
      const hardwarePrice = config.hardwarePrice;
      const topRailPrice = config.topRailPrice * w_m;
      const bottomRailPrice = config.bottomRailPrice * w_m;
      const slingPrice = config.slingPrice * h_m;

      const totalPerUnit = fabricCostPerUnit + hardwarePrice + topRailPrice + bottomRailPrice + slingPrice;
      const grandTotal = totalPerUnit * qty;

      result = {
        id: generateId(),
        type: 'external',
        typeName: 'ม่านม้วนภายนอก',
        w_cm, h_cm, w_m, h_m,
        unitPrice: price,
        qty,
        side: formData.side,
        totalPerUnit,
        grandTotal,
        details: {
          fabricFormula: `${w_m.toFixed(2)} * ${h_m.toFixed(2)} * ${config.fabricFactor} * ${price} = ${fabricCostPerUnit.toFixed(2)}`,
          topRailFormula: `${config.topRailPrice} * ${w_m.toFixed(2)} = ${topRailPrice.toFixed(2)}`,
          bottomRailFormula: `${config.bottomRailPrice} * ${w_m.toFixed(2)} = ${bottomRailPrice.toFixed(2)}`,
          slingFormula: `${config.slingPrice} * ${h_m.toFixed(2)} = ${slingPrice.toFixed(2)}`,
          hardwarePrice,
          sumFormula: `${fabricCostPerUnit.toFixed(1)} + ${hardwarePrice} + ${topRailPrice.toFixed(0)} + ${bottomRailPrice.toFixed(0)} + ${slingPrice.toFixed(1)} = ${totalPerUnit.toFixed(1)}`
        }
      };
    } else if (calcMode === 'internal') {
      const totalPerUnit = fabricCostPerUnit;
      const grandTotal = totalPerUnit * qty;

      result = {
        id: generateId(),
        type: 'internal',
        typeName: 'ม่านม้วนภายใน',
        w_cm, h_cm, w_m, h_m,
        unitPrice: price,
        qty,
        side: formData.side,
        totalPerUnit,
        grandTotal,
        details: {
          mainFormula: `${w_m.toFixed(2)} * ${h_m.toFixed(2)} * ${config.fabricFactor} * ${price} = ${totalPerUnit.toFixed(2)}`,
        }
      };
    } else {
      // Wooden Blinds Logic
      const totalPerUnit = fabricCostPerUnit;
      const grandTotal = totalPerUnit * qty;

      result = {
        id: generateId(),
        type: 'wooden',
        typeName: `มู่ลี่ไม้ (${formData.woodType})`,
        woodType: formData.woodType,
        w_cm, h_cm, w_m, h_m,
        unitPrice: price,
        qty,
        side: formData.side,
        totalPerUnit,
        grandTotal,
        details: {
          mainFormula: `${w_m.toFixed(2)} * ${h_m.toFixed(2)} * 1.2 * ${price} = ${totalPerUnit.toFixed(2)}`,
        }
      };
    }

    setItems([...items, result]);
    setFormData(prev => ({ ...prev, width: '', height: '' }));
  };

  return (
    <div className="pt-20 px-4 pb-40 fade-in">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-xl font-bold text-slate-800">คำนวณราคา</h2>
      </div>
      
      {/* Mode Selector */}
      <div className="bg-slate-100 p-1 rounded-xl flex text-xs font-bold mb-4 overflow-x-auto">
            <button 
                onClick={() => setCalcMode('external')}
                className={`flex-1 py-2 px-2 rounded-lg transition-all whitespace-nowrap ${calcMode === 'external' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}
            >
                ม่านภายนอก
            </button>
            <button 
                onClick={() => setCalcMode('internal')}
                className={`flex-1 py-2 px-2 rounded-lg transition-all whitespace-nowrap ${calcMode === 'internal' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}
            >
                ม่านภายใน
            </button>
            <button 
                onClick={() => setCalcMode('wooden')}
                className={`flex-1 py-2 px-2 rounded-lg transition-all whitespace-nowrap ${calcMode === 'wooden' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}
            >
                มู่ลี่ไม้
            </button>
      </div>

      {/* Input Card */}
      <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 mb-6 relative overflow-hidden">
        <div className={`absolute top-0 left-0 w-1 h-full ${calcMode === 'external' ? 'bg-orange-400' : calcMode === 'wooden' ? 'bg-amber-600' : 'bg-blue-400'}`}></div>
        
        {calcMode === 'wooden' && (
            <div className="mb-4">
                <label className="text-xs font-bold text-slate-400 mb-1 block">ชนิดไม้</label>
                <div className="flex gap-2">
                    <label className={`flex-1 cursor-pointer border rounded-xl py-2 px-2 flex items-center justify-center gap-1 transition-all ${formData.woodType === 'BASSWOOD' ? 'border-amber-500 bg-amber-50 text-amber-800' : 'border-slate-100 text-slate-400'}`}>
                        <input type="radio" name="woodType" value="BASSWOOD" checked={formData.woodType === 'BASSWOOD'} onChange={handleInputChange} className="hidden" />
                        <span className="text-xs font-bold">BASSWOOD</span>
                    </label>
                    <label className={`flex-1 cursor-pointer border rounded-xl py-2 px-2 flex items-center justify-center gap-1 transition-all ${formData.woodType === 'FAUX WOOD' ? 'border-amber-500 bg-amber-50 text-amber-800' : 'border-slate-100 text-slate-400'}`}>
                        <input type="radio" name="woodType" value="FAUX WOOD" checked={formData.woodType === 'FAUX WOOD'} onChange={handleInputChange} className="hidden" />
                        <span className="text-xs font-bold">FAUX WOOD</span>
                    </label>
                </div>
            </div>
        )}

        <div className="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label className="text-xs font-bold text-slate-400 mb-1 block">ความกว้าง (cm)</label>
                <input type="number" name="width" value={formData.width} onChange={handleInputChange} placeholder="0" className="w-full bg-slate-50 rounded-xl p-3 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-100 transition-all" />
            </div>
            <div>
                <label className="text-xs font-bold text-slate-400 mb-1 block">ความสูง (cm)</label>
                <input type="number" name="height" value={formData.height} onChange={handleInputChange} placeholder="0" className="w-full bg-slate-50 rounded-xl p-3 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-100 transition-all" />
            </div>
        </div>

        <div className="grid grid-cols-2 gap-4 mb-4">
             {calcMode !== 'wooden' ? (
                 <div>
                    <label className="text-xs font-bold text-slate-400 mb-1 block">ราคาผ้า (ตร.ม.)</label>
                    <input type="number" name="price" value={formData.price} onChange={handleInputChange} placeholder="฿" className="w-full bg-slate-50 rounded-xl p-3 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-100 transition-all" />
                </div>
             ) : (
                 <div>
                    <label className="text-xs font-bold text-slate-400 mb-1 block">ราคา (ตร.ม.)</label>
                    <div className="w-full bg-slate-100 rounded-xl p-3 font-bold text-slate-500 border border-slate-200">
                        {formatCurrency(formData.woodType === 'BASSWOOD' ? config.basswoodPrice : config.fauxwoodPrice)}
                    </div>
                </div>
             )}
            <div>
                <label className="text-xs font-bold text-slate-400 mb-1 block">จำนวน</label>
                <div className="flex bg-slate-50 rounded-xl overflow-hidden">
                    <button onClick={() => setFormData(p => ({...p, qty: Math.max(1, parseInt(p.qty)-1 || 1).toString()}))} className="px-3 hover:bg-slate-200 text-slate-500 font-bold">-</button>
                    <input type="number" name="qty" value={formData.qty} onChange={handleInputChange} className="w-full bg-transparent text-center font-bold text-slate-700 focus:outline-none py-3" />
                    <button onClick={() => setFormData(p => ({...p, qty: (parseInt(p.qty)+1 || 1).toString()}))} className="px-3 hover:bg-slate-200 text-slate-500 font-bold">+</button>
                </div>
            </div>
        </div>

        <div className="mb-6">
             <label className="text-xs font-bold text-slate-400 mb-2 block">ตำแหน่งโซ่/สลิง</label>
             <div className="flex gap-3">
                {['ซ้าย', 'ขวา'].map((s) => (
                    <label key={s} className={`flex-1 cursor-pointer border rounded-xl py-2 flex items-center justify-center gap-2 transition-all ${formData.side === s ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-100 text-slate-400'}`}>
                        <input type="radio" name="side" value={s} checked={formData.side === s} onChange={handleInputChange} className="hidden" />
                        <span className="text-sm font-bold">{s}</span>
                    </label>
                ))}
             </div>
        </div>

        {errorMsg && (
            <div className="mb-4 p-3 bg-red-50 text-red-500 text-sm rounded-xl flex items-center gap-2 animate-pulse">
                <AlertCircle size={16} /> {errorMsg}
            </div>
        )}

        <button 
            onClick={calculateItem}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all flex justify-center items-center gap-2"
        >
            <Plus size={20} /> เพิ่มรายการ
        </button>
      </div>

      {/* List */}
      {items.length > 0 && (
          <div className="space-y-3">
               <div className="flex justify-between items-center px-1">
                    <span className="text-xs font-bold text-slate-400">รายการทั้งหมด ({items.length})</span>
                    <button onClick={() => setItems([])} className="text-red-400 text-xs flex items-center gap-1 hover:bg-red-50 px-2 py-1 rounded-lg transition-colors"><Trash2 size={12} /> ล้าง</button>
               </div>
               
               {items.map((item, idx) => (
                   <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative group">
                        <button onClick={() => setItems(prev => prev.filter(i => i.id !== item.id))} className="absolute top-3 right-3 text-slate-300 hover:text-red-500 p-1"><X size={16} /></button>
                        <div className="flex items-center gap-2 mb-2">
                             <span className={`w-2 h-2 rounded-full ${item.type === 'external' ? 'bg-orange-400' : item.type === 'wooden' ? 'bg-amber-600' : 'bg-blue-400'}`}></span>
                             <span className="text-xs font-bold text-slate-500">{item.typeName}</span>
                        </div>
                        <div className="flex justify-between items-end">
                            <div>
                                <div className="text-sm font-bold text-slate-700">{item.w_cm} x {item.h_cm} cm</div>
                                <div className="text-xs text-slate-400 mt-0.5">จำนวน {item.qty} ชุด • ปรับ{item.side}</div>
                            </div>
                            <div className="text-lg font-bold text-blue-600">
                                {formatCurrency(item.grandTotal)}
                            </div>
                        </div>
                   </div>
               ))}
               
               {/* Static Action Button for Quote - Moved here */}
               <button 
                    onClick={() => setShowQuote(true)}
                    className="w-full bg-slate-800 text-white px-6 py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 font-bold hover:bg-slate-900 active:scale-95 transition-all mt-4 mb-20"
               >
                    <FileText size={20} /> สรุปราคา {formatCurrency(items.reduce((a,b) => a+b.grandTotal, 0))}
               </button>
          </div>
      )}

      {showQuote && <QuotationModal items={items} onClose={() => setShowQuote(false)} libsLoaded={libsLoaded} config={config} />}
    </div>
  );
};

const QuotationModal = ({ items, onClose, libsLoaded, config }: { items: CalculatorItem[], onClose: () => void, libsLoaded: boolean, config: AppConfig }) => {
    const [showMethod, setShowMethod] = useState(false);
    const quoteRef = useRef<HTMLDivElement>(null);
    const grandTotal = items.reduce((sum, item) => sum + item.grandTotal, 0);

    const handleDownloadPDF = async () => {
        if (!quoteRef.current || !window.html2canvas || !window.jspdf) {
            alert('Libraries not loaded yet, please wait a moment.');
            return;
        }
        try {
            const canvas = await window.html2canvas(quoteRef.current, { scale: 2, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`Quotation_${Date.now()}.pdf`);
        } catch (e) {
            console.error(e);
            alert('Error generating PDF');
        }
    };

    const handleSaveImage = async () => {
         if (!quoteRef.current || !window.html2canvas) return;
         const canvas = await window.html2canvas(quoteRef.current, { scale: 2, useCORS: true });
         const link = document.createElement('a');
         link.download = `Quotation_${Date.now()}.png`;
         link.href = canvas.toDataURL();
         link.click();
    };

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4 fade-in">
            <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl overflow-hidden">
                <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                    <h3 className="font-bold text-slate-700 flex items-center gap-2"><FileText size={20} className="text-blue-500" /> ใบเสนอราคา</h3>
                    <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><X size={20} className="text-slate-400" /></button>
                </div>
                
                <div className="overflow-y-auto flex-1 bg-slate-100 p-4">
                     <div ref={quoteRef} className="bg-white p-6 sm:p-8 rounded-xl shadow-sm printable-content">
                          <div className="text-center border-b pb-6 mb-6">
                               <h1 className="text-2xl font-bold text-slate-800">ใบเสนอราคา</h1>
                               <p className="text-slate-500 text-sm mt-1">วันที่ {new Date().toLocaleDateString('th-TH')}</p>
                          </div>

                          <div className="space-y-4">
                               {items.map((item, i) => (
                                   <div key={item.id} className="border-b border-slate-100 pb-4 last:border-0">
                                        <div className="flex justify-between items-start mb-2">
                                             <div>
                                                  <span className="font-bold text-slate-700 block">{i+1}. {item.typeName}</span>
                                                  <span className="text-xs text-slate-400">ขนาด {item.w_cm}x{item.h_cm} cm | จำนวน {item.qty} ชุด</span>
                                             </div>
                                             <div className="font-bold text-slate-800">{formatCurrency(item.grandTotal)}</div>
                                        </div>
                                        {showMethod && (
                                            <div className="bg-slate-50 p-3 rounded-lg text-xs text-slate-600 mt-2">
                                                <div className="font-bold text-blue-600 mb-1">วิธีคำนวณ (แปลงเป็นเมตร: {item.w_m}x{item.h_m})</div>
                                                {item.type === 'external' ? (
                                                    <ul className="space-y-1 list-disc list-inside opacity-80">
                                                        <li>ผ้า: {item.details.fabricFormula}</li>
                                                        <li>รางบน ({config.topRailPrice}x{item.w_m}): {item.details.topRailFormula}</li>
                                                        <li>รางล่าง ({config.bottomRailPrice}x{item.w_m}): {item.details.bottomRailFormula}</li>
                                                        <li>สลิง ({config.slingPrice}x{item.h_m}): {item.details.slingFormula}</li>
                                                        <li>อุปกรณ์: {formatCurrency(item.details.hardwarePrice || 0)}</li>
                                                        <li className="font-bold text-slate-800 pt-1">รวมต่อชุด: {item.details.sumFormula}</li>
                                                    </ul>
                                                ) : item.type === 'wooden' ? (
                                                    <ul className="space-y-1 list-disc list-inside opacity-80">
                                                        <li>สูตร: กว้าง x สูง x 1.2 x ราคา ({item.unitPrice})</li>
                                                        <li>{item.details.mainFormula} ต่อชุด</li>
                                                    </ul>
                                                ) : (
                                                    <ul className="space-y-1 list-disc list-inside opacity-80">
                                                        <li>สูตร: กว้าง x สูง x {config.fabricFactor} x ราคา</li>
                                                        <li>{item.details.mainFormula} ต่อชุด</li>
                                                    </ul>
                                                )}
                                            </div>
                                        )}
                                   </div>
                               ))}
                          </div>
                          
                          <div className="mt-6 pt-4 border-t-2 border-slate-800 flex justify-between items-center">
                               <span className="text-lg font-bold text-slate-800">ยอดรวมสุทธิ</span>
                               <span className="text-2xl font-bold text-blue-600">{formatCurrency(grandTotal)}</span>
                          </div>
                     </div>
                </div>

                <div className="p-4 bg-white border-t flex flex-col gap-3">
                     <button onClick={() => setShowMethod(!showMethod)} className="w-full py-2 border rounded-lg text-sm font-bold text-slate-500 flex items-center justify-center gap-2 hover:bg-slate-50">
                          {showMethod ? <ChevronUp size={16} /> : <ChevronDown size={16} />} 
                          {showMethod ? 'ซ่อนรายละเอียดวิธีคิด' : 'แสดงรายละเอียดวิธีคิด'}
                     </button>
                     <div className="grid grid-cols-2 gap-3">
                          <button onClick={handleDownloadPDF} disabled={!libsLoaded} className="bg-red-500 hover:bg-red-600 disabled:opacity-50 text-white py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 shadow-md">
                               <Download size={18} /> PDF
                          </button>
                          <button onClick={handleSaveImage} disabled={!libsLoaded} className="bg-indigo-500 hover:bg-indigo-600 disabled:opacity-50 text-white py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 shadow-md">
                               <ImageIcon size={18} /> รูปภาพ
                          </button>
                     </div>
                </div>
            </div>
        </div>
    );
};

// --- Admin Component ---
const AdminModal = ({ isOpen, onClose, isLoggedIn, setLoggedIn, config, setConfig }: any) => {
    const [passcode, setPasscode] = useState('');
    const [editConfig, setEditConfig] = useState(config);
    const [msg, setMsg] = useState('');

    const handleLogin = () => {
        if (passcode === '1988') {
            setLoggedIn(true);
            setMsg('');
        } else {
            setMsg('รหัสผ่านไม่ถูกต้อง');
        }
    };

    const handleSave = () => {
        setConfig(editConfig);
        alert('บันทึกการตั้งค่าเรียบร้อยแล้ว');
        onClose();
    };

    const handleReset = () => {
        if (confirm('ต้องการรีเซ็ตค่าทั้งหมดเป็นค่าเริ่มต้นใช่หรือไม่?')) {
             setEditConfig(DEFAULT_CONFIG);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-[70] flex items-center justify-center p-4 fade-in">
             <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl relative">
                  <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={24} /></button>
                  
                  {!isLoggedIn ? (
                      <div className="p-8 text-center">
                           <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                               <Lock size={32} className="text-slate-500" />
                           </div>
                           <h2 className="text-xl font-bold text-slate-800 mb-6">เข้าสู่ระบบหลังบ้าน</h2>
                           <input 
                              type="password" 
                              value={passcode}
                              onChange={(e) => setPasscode(e.target.value)}
                              placeholder="กรอกรหัสผ่าน"
                              className="w-full bg-slate-100 p-3 rounded-xl text-center text-lg font-bold mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           />
                           {msg && <p className="text-red-500 text-sm mb-4">{msg}</p>}
                           <button onClick={handleLogin} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-colors">เข้าสู่ระบบ</button>
                      </div>
                  ) : (
                      <div className="p-6">
                           <div className="flex items-center gap-3 mb-6 border-b pb-4">
                                <div className="p-2 bg-blue-100 rounded-lg text-blue-600"><Settings size={24} /></div>
                                <div>
                                    <h2 className="text-lg font-bold text-slate-800">ตั้งค่าระบบ</h2>
                                    <p className="text-xs text-slate-400">แก้ไขราคากลางและสูตรคำนวณ</p>
                                </div>
                           </div>
                           
                           <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                                <h3 className="text-xs font-bold text-blue-600 border-b pb-1 mt-2">ม่านม้วน (External)</h3>
                                <AdminInput label="ราคาอุปกรณ์ภายนอก (ชุด)" value={editConfig.hardwarePrice} onChange={(v) => setEditConfig({...editConfig, hardwarePrice: v})} unit="บาท" />
                                <AdminInput label="ราคารางบน (เมตร)" value={editConfig.topRailPrice} onChange={(v) => setEditConfig({...editConfig, topRailPrice: v})} unit="บาท" />
                                <AdminInput label="ราคารางล่าง (เมตร)" value={editConfig.bottomRailPrice} onChange={(v) => setEditConfig({...editConfig, bottomRailPrice: v})} unit="บาท" />
                                <AdminInput label="ราคาสลิงข้าง (เมตร)" value={editConfig.slingPrice} onChange={(v) => setEditConfig({...editConfig, slingPrice: v})} unit="บาท" />
                                <div className="border-t pt-2">
                                     <AdminInput label="ตัวคูณสูตรคำนวณผ้า" value={editConfig.fabricFactor} onChange={(v) => setEditConfig({...editConfig, fabricFactor: v})} unit="เท่า" step={0.1} />
                                </div>

                                <h3 className="text-xs font-bold text-amber-600 border-b pb-1 mt-4">มู่ลี่ไม้ (Wooden)</h3>
                                <AdminInput label="ราคา BASSWOOD" value={editConfig.basswoodPrice} onChange={(v) => setEditConfig({...editConfig, basswoodPrice: v})} unit="บาท" />
                                <AdminInput label="ราคา FAUX WOOD" value={editConfig.fauxwoodPrice} onChange={(v) => setEditConfig({...editConfig, fauxwoodPrice: v})} unit="บาท" />
                           </div>

                           <div className="flex gap-3 mt-6 pt-4 border-t">
                                <button onClick={handleReset} className="p-3 rounded-xl border border-slate-200 text-slate-500 hover:bg-slate-50"><RotateCcw size={20} /></button>
                                <button onClick={handleSave} className="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 flex items-center justify-center gap-2">
                                     <Save size={18} /> บันทึก
                                </button>
                           </div>
                           <button onClick={() => setLoggedIn(false)} className="w-full mt-3 text-xs text-red-400 hover:text-red-500 flex items-center justify-center gap-1">
                                <LogOut size={12} /> ออกจากระบบ
                           </button>
                      </div>
                  )}
             </div>
        </div>
    );
};

const AdminInput = ({ label, value, onChange, unit, step = 1 }: any) => (
    <div>
        <label className="text-xs font-bold text-slate-500 mb-1 block">{label}</label>
        <div className="relative">
            <input 
                type="number" 
                value={value} 
                onChange={(e) => onChange(parseFloat(e.target.value))}
                step={step}
                className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 font-bold text-slate-700 focus:outline-none focus:border-blue-500"
            />
            <span className="absolute right-3 top-2.5 text-xs font-bold text-slate-400">{unit}</span>
        </div>
    </div>
);

// Global Types for window
declare global {
  interface Window {
    html2canvas: any;
    jspdf: any;
  }
}
