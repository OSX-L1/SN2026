<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUNNY Blind System</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SUNNY Blinds">
    <link rel="apple-touch-icon" href="https://img2.pic.in.th/SUNNY-LOGO54c76f9eedf06c96.png">
    <link id="manifest-placeholder" rel="manifest" href="">

    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Sarabun', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f5f5f7;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior: none;
            color: #1d1d1f;
        }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
        }

        .printable-content { background: white; color: black; font-family: 'Sarabun', sans-serif; }

        .input-apple:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05);
            border-color: #86868b;
        }

        .bento-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .bento-card:active {
            transform: scale(0.95);
        }
        
        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 15mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            color: black;
            position: relative;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            .a4-paper { width: 100%; min-height: auto; padding: 10mm 5mm; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIG ---
        const THEMES = {
            default: { id: 'default', name: 'มาตรฐาน (Sunny Red)', bgApp: 'bg-[#f8fafc]', textMain: 'text-slate-800', textSub: 'text-slate-500', primary: 'text-red-600', icon: 'text-red-500', btnPrimary: 'bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white shadow-red-200', btnSecondary: 'bg-white text-slate-700 border-red-100 hover:bg-red-50', bgSoft: 'bg-red-50', border: 'border-red-100', activeTab: 'text-red-600 bg-red-50 shadow-md -translate-y-2', inactiveTab: 'text-gray-400 hover:text-red-500 hover:bg-red-50/50 hover:-translate-y-1', cardBorder: 'border-white hover:border-red-200', inputRing: 'focus:ring-red-100', highlight: 'text-red-600', logoFilter: 'none', toggleActive: 'bg-red-500' },
            apple: { id: 'apple', name: 'Apple Premium (Silver/Bronze)', bgApp: 'bg-[#F5F5F7]', textMain: 'text-[#1D1D1F]', textSub: 'text-[#86868b]', primary: 'text-[#1D1D1F]', icon: 'text-[#86868b]', btnPrimary: 'bg-[#1D1D1F] hover:bg-[#333333] text-white shadow-gray-300', btnSecondary: 'bg-white text-[#1D1D1F] border-gray-200 hover:bg-gray-50', bgSoft: 'bg-[#E5E5EA]', border: 'border-gray-200', activeTab: 'text-[#1D1D1F] bg-white shadow-lg -translate-y-2 ring-1 ring-black/5', inactiveTab: 'text-[#86868b] hover:text-[#1D1D1F] hover:bg-white/50 hover:-translate-y-1', cardBorder: 'border-white/60 hover:border-[#BF9B30]/30', inputRing: 'focus:ring-gray-200', highlight: 'text-[#9A8453]', logoFilter: 'grayscale(20%)', toggleActive: 'bg-[#1D1D1F]' }
        };

        const YOUR_FIREBASE_CONFIG = { apiKey: "AIzaSyCsi2LJcpVAiFBXnmc5XgiIt3UlNFeo2lI", authDomain: "sn2026-9e19e.firebaseapp.com", projectId: "sn2026-9e19e", storageBucket: "sn2026-9e19e.firebasestorage.app", messagingSenderId: "45923511775", appId: "1:45923511775:web:04eca2038d60bfa393a86a", measurementId: "G-PZ1GJM6VHC" };
        let db = null; let auth = null; let appId = 'sunny-blind-system';
        try { let finalConfig = YOUR_FIREBASE_CONFIG; if (typeof __firebase_config !== 'undefined' && __firebase_config) { try { const envConfig = JSON.parse(__firebase_config); if (Object.keys(envConfig).length > 0) finalConfig = envConfig; } catch(e){} } if (typeof __app_id !== 'undefined') appId = __app_id; if (typeof firebase !== 'undefined') { if (!firebase.apps.length) firebase.initializeApp(finalConfig); auth = firebase.auth(); db = firebase.firestore(); } } catch (e) { console.error(e); }

        const formatCurrency = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 2 }).format(amount);
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const DEFAULT_CONFIG = { 
            logoUrl: 'https://img2.pic.in.th/SUNNY-LOGO54c76f9eedf06c96.png', 
            companyName: 'SUNNY BLIND SYSTEM', 
            companyDesc: 'จำหน่ายและติดตั้งผ้าม่าน มู่ลี่ วอลเปเปอร์', 
            companyContact: 'โทร: 02-123-4567', 
            hardwarePrice: 1956, 
            topRailPrice: 200, 
            bottomRailPrice: 150, 
            slingPrice: 138, 
            fabricFactor: 1.2, 
            basswoodPrice: 789, 
            fauxwoodPrice: 750, 
            aluminumWoodPrice: 675, 
            pvc85SolidPrice: 320, 
            pvc85JapanPrice: 699, 
            pvc10SolidPrice: 290, 
            pvc10JapanPrice: 699, 
            pvcEuroPrice: 730,
            // Rails
            railHospitalPrice: 185,
            railHospitalTapePrice: 260,
            railCeilingBracketPrice: 110,
            railTesWhiteBlackPrice: 185,
            railTesWoodPrice: 195,
            railNanoPrice: 220,
            railMManualPrice: 130,
            railMCordPrice: 150,
            
            showExternal: true, 
            showInternal: true, 
            showWooden: true, 
            showAluminum: true, 
            showPVC: true,
            showRail: true, 
            theme: 'default' 
        };

        // --- COMPONENTS ---
        const Icon = ({ path, size = 24, className = "" }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg> );
        const Icons = {
            Home: (p) => <Icon {...p} path={<><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></>} />,
            Calculator: (p) => <Icon {...p} path={<><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></>} />,
            History: (p) => <Icon {...p} path={<><path d="M12 8v4l3 3"></path><circle cx="12" cy="12" r="10"></circle></>} />,
            Settings: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>} />,
            X: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} />,
            ChevronDown: (p) => <Icon {...p} path={<polyline points="6 9 12 15 18 9"></polyline>} />,
            ChevronUp: (p) => <Icon {...p} path={<polyline points="18 15 12 9 6 15"></polyline>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />,
            Image: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>} />,
            RotateCcw: (p) => <Icon {...p} path={<><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></>} />,
            Smartphone: (p) => <Icon {...p} path={<><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></>} />,
            Share: (p) => <Icon {...p} path={<><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></>} />,
            Google: ({ size = 24, className = "" }) => ( <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 48 48" className={className}><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg> ),
            User: (p) => <Icon {...p} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} />,
            Sun: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></>} />,
            Blinds: (p) => <Icon {...p} path={<><path d="M3 3h18"></path><path d="M20 7H4"></path><path d="M20 11H4"></path><path d="M20 15H4"></path><path d="M4 19h16"></path><path d="M8 3v16"></path><path d="M16 3v16"></path></>} />,
            Roller: (p) => <Icon {...p} path={<><rect x="3" y="3" width="18" height="4" rx="1"></rect><rect x="5" y="7" width="14" height="12"></rect><line x1="12" y1="19" x2="12" y2="22"></line><circle cx="12" cy="22" r="1"></circle></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            Fold: (p) => <Icon {...p} path={<><polygon points="11 19 2 12 11 5 11 19"></polygon><polygon points="13 19 22 12 13 5 13 19"></polygon></>} />,
            Wrench: (p) => <Icon {...p} path={<><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></>} />
        };

        // --- 3. SUB-COMPONENTS ---
        const AdminInput = ({ label, value, onChange, unit, step = 1, theme }) => (
            <div><label className="text-xs font-bold text-slate-400 mb-1.5 block ml-1">{label}</label><div className="relative"><input type="number" value={value} onChange={(e) => onChange(parseFloat(e.target.value))} step={step} className={`input-apple w-full bg-white border border-slate-200 rounded-xl p-3 font-bold text-slate-700 ${theme.inputRing}`} /><span className="absolute right-3 top-3 text-sm font-bold text-slate-400">{unit}</span></div></div>
        );
        const AdminTextInput = ({ label, value, onChange, theme }) => (
            <div><label className="text-xs font-bold text-slate-400 mb-1.5 block ml-1">{label}</label><div className="relative"><input type="text" value={value} onChange={(e) => onChange(e.target.value)} className={`input-apple w-full bg-white border border-slate-200 rounded-xl p-3 font-bold text-slate-700 ${theme.inputRing}`} /></div></div>
        );
        const AdminToggle = ({ label, value, onChange, theme }) => (
            <div className="flex justify-between items-center bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><span className="text-sm font-bold text-slate-700">{label}</span><button onClick={() => onChange(!value)} className={`relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none ${value ? theme.toggleActive : 'bg-slate-200'}`}><span className={`inline-block h-5 w-5 transform rounded-full bg-white shadow transition duration-200 ease-in-out ${value ? 'translate-x-6' : 'translate-x-1'}`} /></button></div>
        );
        const NavButton = ({ active, onClick, icon, label, theme }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center w-full h-full rounded-2xl transition-all duration-300 group py-1 ${active ? theme.activeTab : theme.inactiveTab}`}>{icon}<span className={`text-[11px] font-bold mt-0.5 transition-opacity ${active ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>{label}</span></button>
        );

        // --- 4. MODALS ---
        const QuotationModal = ({ items, onClose, config, userProfile, theme }) => {
            const [showVat, setShowVat] = useState(false);
            const [showMethod, setShowMethod] = useState(false);
            const [showDiscount, setShowDiscount] = useState(false);
            const [discountPercent, setDiscountPercent] = useState(0);
            const [customerName, setCustomerName] = useState('');
            const [customerAddress, setCustomerAddress] = useState('');
            const [generating, setGenerating] = useState(false);
            const quoteRef = useRef(null);
            
            const displayCompanyName = userProfile?.shopName || config.companyName || 'SUNNY BLIND SYSTEM';
            const displayCompanyDesc = userProfile?.address || config.companyDesc || 'จำหน่ายและติดตั้งผ้าม่าน มู่ลี่ วอลเปเปอร์';
            const displayCompanyContact = userProfile?.phone || config.companyContact || 'โทร: 02-123-4567';
            
            const subtotal = items.reduce((sum, item) => sum + item.grandTotal, 0);
            const discountAmount = showDiscount ? (subtotal * (parseFloat(discountPercent) || 0) / 100) : 0;
            const totalAfterDiscount = subtotal - discountAmount;
            const vatAmount = showVat ? totalAfterDiscount * 0.07 : 0;
            const grandTotal = totalAfterDiscount + vatAmount;

            const generateCanvas = async () => {
                if (!quoteRef.current || !window.html2canvas) return null;
                const cloneContainer = document.createElement('div');
                cloneContainer.style.width = '210mm';
                cloneContainer.style.minHeight = '297mm';
                cloneContainer.style.position = 'fixed';
                cloneContainer.style.top = '-10000px';
                cloneContainer.style.left = '0';
                cloneContainer.style.zIndex = '-1';
                cloneContainer.style.background = 'white';
                document.body.appendChild(cloneContainer);

                const clone = quoteRef.current.cloneNode(true);
                clone.style.width = '210mm';
                clone.style.minHeight = '297mm';
                clone.style.padding = '15mm';
                clone.style.fontSize = '';
                clone.style.margin = '0';
                clone.style.boxShadow = 'none';
                clone.style.transform = 'none';

                const originalTextareas = quoteRef.current.querySelectorAll('textarea');
                const clonedTextareas = clone.querySelectorAll('textarea');
                originalTextareas.forEach((orig, index) => {
                    const cloned = clonedTextareas[index];
                    if (cloned) {
                        const div = document.createElement('div');
                        div.style.cssText = window.getComputedStyle(orig).cssText;
                        div.style.height = 'auto';
                        div.style.minHeight = orig.style.height;
                        div.style.resize = 'none';
                        div.style.overflow = 'visible';
                        div.style.whiteSpace = 'pre-wrap';
                        div.style.border = '1px solid #e2e8f0';
                        div.innerText = orig.value;
                        if (cloned.parentNode) cloned.parentNode.replaceChild(div, cloned);
                    }
                });

                const originalInputs = quoteRef.current.querySelectorAll('input[type="text"]');
                const clonedInputs = clone.querySelectorAll('input[type="text"]');
                originalInputs.forEach((orig, index) => {
                    if (clonedInputs[index]) clonedInputs[index].setAttribute('value', orig.value);
                });

                cloneContainer.appendChild(clone);

                try {
                    const canvas = await window.html2canvas(clone, { scale: 2, useCORS: true, windowWidth: 1280, width: 794 });
                    document.body.removeChild(cloneContainer);
                    return canvas;
                } catch (error) {
                    console.error("Capture failed:", error);
                    document.body.removeChild(cloneContainer);
                    return null;
                }
            };

            const handleDownloadPDF = async () => {
                setGenerating(true);
                const canvas = await generateCanvas();
                if (!canvas) { setGenerating(false); return; }
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Quotation_${Date.now()}.pdf`);
                setGenerating(false);
            };

            const handleSaveImage = async () => {
                setGenerating(true);
                const canvas = await generateCanvas();
                if (!canvas) { setGenerating(false); return; }
                const link = document.createElement('a');
                link.download = `Quotation_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                setGenerating(false);
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[70] flex items-center justify-center p-4 fade-in">
                    <div className={`bg-white rounded-[2rem] w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl overflow-hidden scale-in ${theme.textMain}`}>
                        <div className="p-4 border-b flex flex-wrap justify-between items-center bg-slate-50/80 backdrop-blur-sm gap-4">
                            <h3 className={`font-bold text-lg flex items-center gap-2 ${theme.textMain}`}><Icons.FileText size={24} className={theme.icon} /> ใบเสนอราคาตัวอย่าง</h3>
                            <div className="flex items-center gap-3 flex-wrap">
                                <label className={`flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm hover:border-gray-300 transition-all select-none hover:-translate-y-0.5 ${theme.textMain}`}><input type="checkbox" checked={showVat} onChange={() => setShowVat(!showVat)} className="w-4 h-4 rounded border-gray-300" /><span className="text-sm font-bold">VAT 7%</span></label>
                                <label className={`flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm hover:border-gray-300 transition-all select-none hover:-translate-y-0.5 ${theme.textMain}`}><input type="checkbox" checked={showMethod} onChange={() => setShowMethod(!showMethod)} className="w-4 h-4 rounded border-gray-300" /><span className="text-sm font-bold">วิธีคำนวณ</span></label>
                                <label className={`flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm hover:border-gray-300 transition-all select-none hover:-translate-y-0.5 ${theme.textMain}`}>
                                    <input type="checkbox" checked={showDiscount} onChange={() => setShowDiscount(!showDiscount)} className="w-4 h-4 rounded border-gray-300" />
                                    <span className="text-sm font-bold">ส่วนลด %</span>
                                </label>
                                {showDiscount && (
                                    <div className="flex items-center bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm">
                                        <input type="number" value={discountPercent} onChange={(e) => setDiscountPercent(e.target.value)} className="w-12 text-sm font-bold text-right outline-none" placeholder="0" />
                                        <span className="text-sm font-bold ml-1">%</span>
                                    </div>
                                )}
                                <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600 transition-colors hover:scale-110"><Icons.X size={24} /></button>
                            </div>
                        </div>
                        <div className="overflow-y-auto flex-1 bg-slate-100 p-4 md:p-8 flex justify-center">
                            <div ref={quoteRef} className="a4-paper relative flex flex-col shadow-xl">
                                <div className="flex justify-between items-start mb-8">
                                    <div className="flex items-center gap-4">
                                        <img src={config.logoUrl} className="h-20 w-auto object-contain" alt="Company Logo" onError={(e) => e.target.style.display = 'none'} />
                                        <div><h1 className="text-2xl font-bold text-slate-800">{displayCompanyName}</h1><p className="text-sm text-slate-500">{displayCompanyDesc}</p><p className="text-sm text-slate-500">{displayCompanyContact}</p></div>
                                    </div>
                                    <div className="text-right"><div className="text-3xl font-bold text-red-100 uppercase tracking-widest mb-2">Quotation</div><div className="text-sm font-bold text-slate-600">ใบเสนอราคา</div><div className="text-sm text-slate-500 mt-1">วันที่: {new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div>
                                </div>
                                <div className="border-t-2 border-b-2 border-slate-100 py-4 mb-6 flex gap-4">
                                    <div className="w-1/3"><label className="text-xs font-bold text-slate-400 block mb-1">ลูกค้า (Customer):</label><textarea rows="3" className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-sm font-bold text-slate-700 focus:outline-none focus:border-slate-400 placeholder-slate-300 resize-none" placeholder="ระบุชื่อลูกค้า..." value={customerName} onChange={(e) => setCustomerName(e.target.value)} /></div>
                                    <div className="w-2/3"><label className="text-xs font-bold text-slate-400 block mb-1">ที่อยู่ (Address):</label><textarea rows="3" className="w-full bg-slate-50 border border-slate-200 rounded px-2 py-1 text-sm text-slate-700 focus:outline-none focus:border-slate-400 placeholder-slate-300 resize-none" placeholder="ระบุที่อยู่..." value={customerAddress} onChange={(e) => setCustomerAddress(e.target.value)} /></div>
                                </div>
                                <table className="w-full text-sm mb-auto">
                                    <thead><tr className="bg-red-600 text-white"><th className="py-2 px-3 text-center w-12 rounded-tl-lg">ลำดับ</th><th className="py-2 px-3 text-left">รายการสินค้า</th><th className="py-2 px-3 text-center whitespace-nowrap">ขนาด (cm)</th><th className="py-2 px-3 text-center">ปรับ</th><th className="py-2 px-3 text-center">จำนวน</th><th className="py-2 px-3 text-right">ราคา/หน่วย</th><th className="py-2 px-3 text-right rounded-tr-lg">รวมเงิน</th></tr></thead>
                                    <tbody className="text-slate-700">{items.map((item, index) => (<React.Fragment key={item.id}><tr className="border-b border-slate-100 hover:bg-slate-50"><td className="py-3 px-3 text-center font-medium text-slate-400">{index + 1}</td><td className="py-3 px-3 font-bold">{item.typeName}</td><td className="py-3 px-3 text-center font-mono text-xs whitespace-nowrap">{item.w_cm} x {item.h_cm}</td><td className="py-3 px-3 text-center">{item.side}</td><td className="py-3 px-3 text-center">{item.qty}</td><td className="py-3 px-3 text-right font-mono">{formatCurrency(item.totalPerUnit)}</td><td className="py-3 px-3 text-right font-bold">{formatCurrency(item.grandTotal)}</td></tr>{showMethod && (<tr className="bg-slate-50 border-b border-slate-100"><td colSpan="7" className="py-2 px-4 text-xs text-slate-500"><div className="font-bold text-slate-700 mb-1">วิธีคำนวณ:</div><ul className="list-disc list-inside space-y-0.5"><li>ผ้า: {item.details.fabricFormula}</li>{item.type === 'external' && (<><li>รางบน: {item.details.topRailFormula}</li><li>รางล่าง: {item.details.bottomRailFormula}</li><li>สลิง: {item.details.slingFormula}</li><li>อุปกรณ์: {formatCurrency(item.details.hardwarePrice)}</li><li className="font-bold text-red-600">รวมต่อชุด: {item.details.sumFormula}</li></>)}{item.type !== 'external' && <li>{item.details.mainFormula}</li>}</ul></td></tr>)}</React.Fragment>))}</tbody>
                                </table>
                                <div className="mt-8 flex justify-end">
                                    <div className="w-64 space-y-2">
                                        <div className="flex justify-between text-slate-600"><span>รวมเป็นเงิน</span><span className="font-bold">{formatCurrency(subtotal)}</span></div>
                                        {showDiscount && <div className="flex justify-between text-red-500"><span>ส่วนลด {discountPercent}%</span><span className="font-bold">-{formatCurrency(discountAmount)}</span></div>}
                                        {showDiscount && <div className="flex justify-between text-slate-600"><span>หลังหักส่วนลด</span><span className="font-bold">{formatCurrency(totalAfterDiscount)}</span></div>}
                                        {showVat && (<div className="flex justify-between text-slate-600"><span>ภาษีมูลค่าเพิ่ม 7%</span><span className="font-bold">{formatCurrency(vatAmount)}</span></div>)}
                                        <div className="flex justify-between text-lg font-bold text-red-600 border-t-2 border-red-200 pt-2 mt-2"><span>จำนวนเงินทั้งสิ้น</span><span>{formatCurrency(grandTotal)}</span></div>
                                    </div>
                                </div>
                                <div className="mt-12 flex justify-between text-center"><div className="mt-8"><div className="w-40 border-b border-slate-300 mb-2"></div><p className="text-xs text-slate-400">ผู้เสนอราคา</p></div><div className="mt-8"><div className="w-40 border-b border-slate-300 mb-2"></div><p className="text-xs text-slate-400">ผู้อนุมัติสั่งซื้อ</p></div></div>
                            </div>
                        </div>
                        <div className="p-5 bg-white border-t flex flex-col md:flex-row gap-4">
                            <button onClick={handleDownloadPDF} disabled={generating} className={`flex-1 ${theme.btnPrimary} py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md text-base transition-colors hover:-translate-y-1 disabled:opacity-50`}>{generating ? 'กำลังสร้าง PDF...' : <><Icons.Download size={20} /> ดาวน์โหลด PDF (A4)</>}</button>
                            <button onClick={handleSaveImage} disabled={generating} className={`flex-1 ${theme.btnSecondary} py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-md text-base transition-colors hover:-translate-y-1 disabled:opacity-50`}>{generating ? 'กำลังบันทึก...' : <><Icons.Image size={20} /> บันทึกเป็นรูปภาพ</>}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ProfileModal = ({ user, userProfile, onClose, onLogout, onLoad, onSaveProfile, theme }) => {
            const [savedQuotes, setSavedQuotes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({ displayName: userProfile?.displayName || user.displayName, shopName: userProfile?.shopName || '', address: userProfile?.address || '', phone: userProfile?.phone || '', photoURL: userProfile?.photoURL || user.photoURL });

             useEffect(() => {
                if (!db) return;
                const q = db.collection('artifacts').doc('sunny-blind-system').collection('users').doc(user.uid).collection('quotations'); 
                const unsub = q.onSnapshot(snap => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    data.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                    setSavedQuotes(data);
                    setLoading(false);
                });
                return () => unsub();
            }, [user]);

            const deleteQuote = async (e, id) => { e.stopPropagation(); if(!confirm("ต้องการลบรายการนี้?")) return; try { await db.collection('artifacts').doc('sunny-blind-system').collection('users').doc(user.uid).collection('quotations').doc(id).delete(); } catch(e) { alert(e.message); } };
            const handleSave = () => { onSaveProfile(editData); setIsEditing(false); };

            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] flex items-end sm:items-center justify-center p-4 fade-in">
                    <div className={`${theme.bgApp} rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl relative flex flex-col max-h-[85vh] slide-up`}>
                        <div className={`p-5 border-b ${theme.border} flex justify-between items-center bg-white/50 backdrop-blur-md`}><h3 className={`font-bold text-lg flex items-center gap-2 ${theme.textMain}`}><Icons.User size={24} className={theme.icon} /> โปรไฟล์ของฉัน</h3><button onClick={onClose} className="p-2 bg-white/50 rounded-full hover:bg-white transition-colors"><Icons.X size={20} className={theme.textSub} /></button></div>
                        <div className="p-6 flex flex-col items-center bg-white relative">
                            <div className="absolute top-4 right-4 z-20"><button onClick={() => setIsEditing(!isEditing)} className={`p-2 rounded-full ${theme.bgSoft} ${theme.textSub} hover:${theme.primary} transition-colors`}>{isEditing ? <Icons.X size={18} /> : <Icons.Edit size={18} />}</button></div>
                            <img src={isEditing ? editData.photoURL : (userProfile?.photoURL || user.photoURL)} className="w-24 h-24 rounded-full border-4 border-white shadow-lg mb-4 object-cover" />
                            {!isEditing ? (<><h2 className={`text-xl font-bold ${theme.textMain}`}>{userProfile?.displayName || user.displayName}</h2>{userProfile?.shopName && <p className={`text-sm font-bold mt-1 ${theme.highlight}`}>{userProfile.shopName}</p>}<p className={`text-sm mt-1 ${theme.textSub}`}>{user.email}</p><button onClick={onLogout} className={`mt-6 text-xs font-bold px-5 py-2.5 rounded-full flex items-center gap-2 transition-colors ${theme.bgSoft} ${theme.primary}`}><Icons.LogOut size={16} /> ออกจากระบบ</button></>) : (<div className="w-full space-y-3 mt-2"><AdminTextInput label="ชื่อที่แสดง" value={editData.displayName} onChange={v => setEditData({...editData, displayName: v})} theme={theme} /><AdminTextInput label="ชื่อร้านค้า" value={editData.shopName} onChange={v => setEditData({...editData, shopName: v})} theme={theme} /><AdminTextInput label="ที่อยู่ร้าน" value={editData.address} onChange={v => setEditData({...editData, address: v})} theme={theme} /><AdminTextInput label="เบอร์โทรศัพท์" value={editData.phone} onChange={v => setEditData({...editData, phone: v})} theme={theme} /><AdminTextInput label="URL รูปโปรไฟล์" value={editData.photoURL} onChange={v => setEditData({...editData, photoURL: v})} theme={theme} /><button onClick={handleSave} className={`w-full font-bold py-2 rounded-xl mt-2 ${theme.btnPrimary}`}>บันทึกข้อมูล</button></div>)}
                        </div>
                        {!isEditing && (<div className="flex-1 overflow-y-auto p-5"><h4 className={`text-xs font-bold uppercase tracking-wider mb-4 ml-1 ${theme.textSub}`}>ประวัติใบเสนอราคา ({savedQuotes.length})</h4>{loading ? <p className={`text-center text-sm py-10 ${theme.textSub}`}>กำลังโหลด...</p> : (<div className="space-y-3">{savedQuotes.length === 0 && <div className={`text-center py-10 text-sm bg-white rounded-2xl border border-dashed ${theme.border} ${theme.textSub}`}>ไม่มีประวัติการบันทึก</div>}{savedQuotes.map(q => (<div key={q.id} onClick={() => onLoad(q.items)} className={`bg-white p-4 rounded-2xl shadow-sm border border-white cursor-pointer transition-all hover:shadow-md hover:-translate-y-1 group ${theme.cardBorder}`}><div className="flex justify-between items-start"><div><h3 className={`font-bold text-sm transition-colors ${theme.textMain} group-hover:${theme.highlight}`}>{q.name || 'ไม่มีชื่อ'}</h3><div className="flex items-center gap-2 mt-1"><span className={`text-[10px] px-2 py-0.5 rounded-md ${theme.bgSoft} ${theme.textSub}`}>{new Date(q.createdAt).toLocaleDateString('th-TH')}</span><span className={`text-[10px] ${theme.textSub}`}>{q.items.length} รายการ</span></div></div><div className="flex flex-col items-end gap-2"><span className={`font-bold text-sm ${theme.highlight}`}>{formatCurrency(q.total)}</span><button onClick={(e) => deleteQuote(e, q.id)} className={`p-1.5 rounded-lg transition-colors ${theme.textSub} hover:${theme.primary} hover:${theme.bgSoft}`}><Icons.Trash2 size={16} /></button></div></div></div>))}</div>)}</div>)}
                    </div>
                </div>
            );
        };

        const AdminModal = ({ isOpen, onClose, isLoggedIn, setLoggedIn, config, onSave, theme, onSaveAluminum, aluminumPrices }) => {
            const [passcode, setPasscode] = useState('');
            const [editConfig, setEditConfig] = useState(config);
            const [msg, setMsg] = useState('');
            const fileInputRef = useRef(null);
            
            const handleLogin = () => { if (passcode === '1988') { setLoggedIn(true); setMsg(''); } else setMsg('รหัสผ่านไม่ถูกต้อง'); };
            const handleReset = () => { if (confirm('ต้องการรีเซ็ตค่าทั้งหมดเป็นค่าเริ่มต้นใช่หรือไม่?')) setEditConfig(DEFAULT_CONFIG); };
            
            const handleCSVUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    complete: (results) => {
                        const rawData = results.data;
                        const header = rawData[0];
                        if (!header) return alert('ไฟล์ CSV ไม่ถูกต้อง');
                        const widths = header.slice(1).map(h => parseInt(h)); 
                        const table = {};
                        for (let i = 1; i < rawData.length; i++) {
                            const row = rawData[i];
                            if (row.length < 2) continue; 
                            const height = parseInt(row[0]);
                            if (isNaN(height)) continue;
                            table[height] = {};
                            for (let j = 1; j < row.length; j++) {
                                const price = parseInt(row[j]);
                                if (!isNaN(price) && widths[j-1]) { table[height][widths[j-1]] = price; }
                            }
                        }
                        onSaveAluminum({ widths, table });
                    }
                });
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] flex items-center justify-center p-4 fade-in">
                    <div className={`bg-white rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl relative flex flex-col max-h-[85vh] scale-in`}>
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center"><h3 className={`font-bold text-lg ${theme.textMain}`}>ตั้งค่าระบบ</h3><button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><Icons.X size={24} className="text-slate-400" /></button></div>
                        {!isLoggedIn ? (<div className="p-8 text-center"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Lock size={32} className="text-slate-500" /></div><h2 className="text-xl font-bold text-slate-800 mb-6">เข้าสู่ระบบหลังบ้าน</h2><input type="password" value={passcode} onChange={(e) => setPasscode(e.target.value)} placeholder="กรอกรหัสผ่าน" className="input-apple w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-center text-lg font-bold mb-4" />{msg && <p className="text-red-500 text-sm mb-4">{msg}</p>}<button onClick={handleLogin} className={`w-full py-3 rounded-xl font-bold transition-colors ${theme.btnPrimary}`}>เข้าสู่ระบบ</button></div>) : (<div className="p-6 flex-1 overflow-y-auto"><div className="space-y-5"><h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider">ฐานข้อมูลราคา (Price Tables)</h3><div className="p-4 border border-dashed border-slate-300 rounded-xl bg-slate-50 text-center"><h4 className="font-bold text-slate-700 mb-2">มู่ลี่อลูมิเนียม (Aluminum)</h4><p className="text-xs text-slate-500 mb-3">{aluminumPrices ? '✅ มีข้อมูลในระบบแล้ว' : '❌ ยังไม่มีข้อมูล'}</p><input type="file" accept=".csv" ref={fileInputRef} className="hidden" onChange={handleCSVUpload} /><button onClick={() => fileInputRef.current.click()} className="text-xs bg-white border border-slate-300 px-3 py-2 rounded-lg font-bold text-slate-600 hover:bg-slate-100 flex items-center justify-center gap-2 mx-auto"><Icons.Upload size={14} /> อัปโหลด CSV มู่ลี่อลูมิเนียม</button><p className="text-[10px] text-slate-400 mt-2">รูปแบบ CSV: แถวแรกเป็นความกว้าง คอลัมน์แรกเป็นความสูง</p></div><h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider">ข้อมูลร้านค้า</h3><div className="mb-4"><label className="text-xs font-bold text-slate-400 mb-1.5 block ml-1">เลือกธีม (Theme)</label><select value={editConfig.theme} onChange={(e) => setEditConfig({...editConfig, theme: e.target.value})} className="input-apple w-full bg-white border border-slate-200 rounded-xl p-3 font-bold text-slate-700">{Object.values(THEMES).map(t => (<option key={t.id} value={t.id}>{t.name}</option>))}</select></div><AdminTextInput label="ลิงก์รูปโลโก้ (URL)" value={editConfig.logoUrl} onChange={(v) => setEditConfig({...editConfig, logoUrl: v})} theme={theme} /><AdminTextInput label="ชื่อร้าน/บริษัท" value={editConfig.companyName} onChange={(v) => setEditConfig({...editConfig, companyName: v})} theme={theme} /><AdminTextInput label="รายละเอียด/ที่อยู่" value={editConfig.companyDesc} onChange={(v) => setEditConfig({...editConfig, companyDesc: v})} theme={theme} /><AdminTextInput label="เบอร์โทรติดต่อ" value={editConfig.companyContact} onChange={(v) => setEditConfig({...editConfig, companyContact: v})} theme={theme} /><h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mt-6">เมนูคำนวณ</h3><div className="space-y-2"><AdminToggle label="ม่านภายนอก" value={editConfig.showExternal} onChange={v => setEditConfig({...editConfig, showExternal: v})} theme={theme} /><AdminToggle label="ม่านภายใน" value={editConfig.showInternal} onChange={v => setEditConfig({...editConfig, showInternal: v})} theme={theme} /><AdminToggle label="มู่ลี่ไม้" value={editConfig.showWooden} onChange={v => setEditConfig({...editConfig, showWooden: v})} theme={theme} /><AdminToggle label="มู่ลี่อลูมิเนียม" value={editConfig.showAluminum} onChange={v => setEditConfig({...editConfig, showAluminum: v})} theme={theme} /><AdminToggle label="ฉากกั้นห้อง PVC" value={editConfig.showPVC} onChange={v => setEditConfig({...editConfig, showPVC: v})} theme={theme} /><AdminToggle label="รางม่าน" value={editConfig.showRail} onChange={v => setEditConfig({...editConfig, showRail: v})} theme={theme} /></div><h3 className="text-sm font-bold text-blue-500 uppercase tracking-wider mt-6">ราคากลาง (External)</h3><AdminInput label="ราคาอุปกรณ์ภายนอก" value={editConfig.hardwarePrice} onChange={(v) => setEditConfig({...editConfig, hardwarePrice: v})} unit="บาท" theme={theme} /><AdminInput label="ราคารางบน" value={editConfig.topRailPrice} onChange={(v) => setEditConfig({...editConfig, topRailPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ราคารางล่าง" value={editConfig.bottomRailPrice} onChange={(v) => setEditConfig({...editConfig, bottomRailPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ราคาสลิงข้าง" value={editConfig.slingPrice} onChange={(v) => setEditConfig({...editConfig, slingPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ตัวคูณสูตรผ้า" value={editConfig.fabricFactor} onChange={(v) => setEditConfig({...editConfig, fabricFactor: v})} unit="เท่า" step={0.1} theme={theme} /><h3 className="text-sm font-bold text-amber-500 uppercase tracking-wider mt-6">ราคากลาง (Wooden)</h3><AdminInput label="ราคา BASSWOOD" value={editConfig.basswoodPrice} onChange={(v) => setEditConfig({...editConfig, basswoodPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ราคา FAUX WOOD" value={editConfig.fauxwoodPrice} onChange={(v) => setEditConfig({...editConfig, fauxwoodPrice: v})} unit="บาท" theme={theme} /><h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mt-6">ราคากลาง (Aluminum)</h3><AdminInput label="ราคาลายไม้ (ต่อ ตร.ม.)" value={editConfig.aluminumWoodPrice} onChange={(v) => setEditConfig({...editConfig, aluminumWoodPrice: v})} unit="บาท" theme={theme} /><h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider mt-6">ราคากลาง (PVC)</h3><AdminInput label="ใบ 8.5cm แบบทึบ" value={editConfig.pvc85SolidPrice} onChange={(v) => setEditConfig({...editConfig, pvc85SolidPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ใบ 8.5cm ญี่ปุ่น" value={editConfig.pvc85JapanPrice} onChange={(v) => setEditConfig({...editConfig, pvc85JapanPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ใบ 10cm แบบทึบ" value={editConfig.pvc10SolidPrice} onChange={(v) => setEditConfig({...editConfig, pvc10SolidPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ใบ 10cm ญี่ปุ่น" value={editConfig.pvc10JapanPrice} onChange={(v) => setEditConfig({...editConfig, pvc10JapanPrice: v})} unit="บาท" theme={theme} /><AdminInput label="ใบ 12.3cm ยูโร (รวม)" value={editConfig.pvcEuroPrice} onChange={(v) => setEditConfig({...editConfig, pvcEuroPrice: v})} unit="บาท" theme={theme} /><h3 className="text-sm font-bold text-purple-500 uppercase tracking-wider mt-6">ราคากลาง (Curtain Rails)</h3><AdminInput label="รางโรงพยาบาล" value={editConfig.railHospitalPrice} onChange={(v) => setEditConfig({...editConfig, railHospitalPrice: v})} unit="บาท/ม." theme={theme} /><AdminInput label="รางโรงพยาบาลลอนเทป" value={editConfig.railHospitalTapePrice} onChange={(v) => setEditConfig({...editConfig, railHospitalTapePrice: v})} unit="บาท/ม." theme={theme} /><AdminInput label="แป๊ดยึดเพดาน" value={editConfig.railCeilingBracketPrice} onChange={(v) => setEditConfig({...editConfig, railCeilingBracketPrice: v})} unit="บาท/ชุด" theme={theme} /><AdminInput label="รางลอนเทป TES ขาว/ดำ" value={editConfig.railTesWhiteBlackPrice} onChange={(v) => setEditConfig({...editConfig, railTesWhiteBlackPrice: v})} unit="บาท/ม." theme={theme} /><AdminInput label="รางลอนเทป TES ลายไม้" value={editConfig.railTesWoodPrice} onChange={(v) => setEditConfig({...editConfig, railTesWoodPrice: v})} unit="บาท/ม." theme={theme} /><AdminInput label="รางลอนเทป NANO" value={editConfig.railNanoPrice} onChange={(v) => setEditConfig({...editConfig, railNanoPrice: v})} unit="บาท/ม." theme={theme} /><AdminInput label="ราง M (มือดึง)" value={editConfig.railMManualPrice} onChange={(v) => setEditConfig({...editConfig, railMManualPrice: v})} unit="บาท/ม." theme={theme} /><AdminInput label="ราง M (เชือกดึง)" value={editConfig.railMCordPrice} onChange={(v) => setEditConfig({...editConfig, railMCordPrice: v})} unit="บาท/ม." theme={theme} /></div><div className="flex gap-3 mt-8 pt-4 border-t"><button onClick={handleReset} className="p-3 rounded-xl border border-slate-200 text-slate-500 hover:bg-slate-50"><Icons.RotateCcw size={20} /></button><button onClick={() => onSave(editConfig)} className={`flex-1 font-bold py-3 rounded-xl flex items-center justify-center gap-2 ${theme.btnPrimary}`}><Icons.Save size={18} /> บันทึกออนไลน์</button></div><button onClick={() => setLoggedIn(false)} className="w-full mt-3 text-xs text-red-400 hover:text-red-500 flex items-center justify-center gap-1"><Icons.LogOut size={12} /> ออกจากระบบ</button></div>)}
                    </div>
                </div>
            );
        };

        // --- 5. PAGES ---
        const HomePage = ({ setActiveTab, config, onInstall, theme }) => (
            <div className="flex flex-col items-center justify-center h-full pt-32 p-8 text-center fade-in pb-32">
                <div className="relative mb-8 group">
                    <img src={config.logoUrl} alt="Logo" className="relative h-48 w-auto object-contain drop-shadow-xl transform transition-transform duration-500 hover:scale-105" onError={(e) => e.target.style.display = 'none'} />
                </div>
                
                <h2 className={`text-3xl font-bold mb-3 tracking-tight ${theme.textMain}`}>Sunny Blind System</h2>
                <p className={`${theme.textSub} mb-10 max-w-xs leading-relaxed text-sm font-medium`}>
                  ระบบจัดการร้านม่านครบวงจร<br/>คำนวณราคา เช็คสต็อก ออกใบเสนอราคา
                </p>
                
                <div className="flex flex-col gap-4 w-full max-w-xs">
                    <button onClick={() => setActiveTab('calculator')} className={`${theme.btnPrimary} px-8 py-4 rounded-2xl font-bold text-lg active:scale-95 transition-all flex justify-center items-center gap-3 hover:-translate-y-1 shadow-lg`}><Icons.Calculator size={22} /> เริ่มคำนวณราคา</button>
                    <button onClick={onInstall} className={`${theme.btnSecondary} px-8 py-4 rounded-2xl font-bold text-lg shadow-md active:scale-95 transition-all flex justify-center items-center gap-3 hover:-translate-y-1`}><Icons.Smartphone size={22} className={theme.icon} /> ติดตั้งแอปพลิเคชัน</button>
                </div>
            </div>
        );

        // --- STOCK CHECKERS ---

        const WoodStockChecker = ({ theme, onBack }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchResult, setSearchResult] = useState(null);
            const [error, setError] = useState('');
            const [showDebug, setShowDebug] = useState(false); // Debug toggle
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAll, setShowAll] = useState(false); // New state for View All

            const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1132498145&single=true&output=csv';

            // Define the size columns we expect
            const sizeMap = [
                { label: '4.0 ft', keys: ['4ft', '4.0', '4.00'] },
                { label: '4.5 ft', keys: ['4.5ft', '4.5', '4.50'] },
                { label: '5.0 ft', keys: ['5ft', '5.0', '5.00'] },
                { label: '5.5 ft', keys: ['5.5ft', '5.5', '5.50'] },
                { label: '6.0 ft', keys: ['6ft', '6.0', '6.00'] },
                { label: '6.5 ft', keys: ['6.5ft', '6.5', '6.50'] },
                { label: '7.0 ft', keys: ['7ft', '7.0', '7.00'] },
                { label: '8.0 ft', keys: ['8ft', '8.0', '8.00'] }
            ];

            useEffect(() => {
                setLoading(true);
                Papa.parse(SHEET_URL, {
                    download: true,
                    header: false, // Changed to false to handle custom headers
                    skipEmptyLines: true,
                    complete: (results) => {
                        const mergedData = preprocessData(results.data);
                        setData(mergedData);
                        setLoading(false);
                    },
                    error: (err) => {
                        console.error(err);
                        setError('ไม่สามารถดึงข้อมูลสต็อกได้');
                        setLoading(false);
                    }
                });
            }, []);

            const preprocessData = (rows) => {
                if (!rows || rows.length < 2) return [];
                
                let headerRowIndex = -1;
                let codeIdx = -1;
                let nameIdx = -1;
                const columnIndices = {};

                // 1. Detect Header Row
                for (let i = 0; i < Math.min(rows.length, 10); i++) {
                    const row = rows[i].map(c => String(c).trim().toLowerCase());
                    
                    // Look for key columns to identify header row
                    const hasSize = row.some(c => c.includes('4ft') || c.includes('4.0'));
                    const hasCode = row.some(c => c === 'code' || c === 'รหัส' || c.includes('รหัสสินค้า') || c.includes('code'));
                    
                    if (hasSize || hasCode) {
                        headerRowIndex = i;
                        
                        // Identify Code Column
                        codeIdx = row.findIndex(c => c === 'code' || c === 'รหัส' || c.includes('code') || c.includes('รหัสสินค้า'));
                        if (codeIdx === -1) codeIdx = 0; // Default to first col if not found explicitly

                        // Identify Name Column
                        nameIdx = row.findIndex(c => c === 'name' || c === 'ชื่อ' || c.includes('name') || c.includes('ชื่อสินค้า'));
                        if (nameIdx === -1 || nameIdx === codeIdx) nameIdx = codeIdx + 1; // Default to next col

                        // Identify Size Columns dynamically
                        sizeMap.forEach(size => {
                            // Find column that matches any of the keys for this size
                            const idx = row.findIndex(cell => size.keys.some(k => cell.replace(/\s/g,'').includes(k)));
                            if (idx !== -1) columnIndices[size.label] = idx;
                        });
                        break;
                    }
                }

                // Fallback if no header found
                if (headerRowIndex === -1) {
                    headerRowIndex = 0; codeIdx = 0; nameIdx = 1;
                    // Try to guess columns sequentially starting from 2
                    let currentDataCol = 2;
                    sizeMap.forEach(size => {
                        if (columnIndices[size.label] === undefined) {
                            columnIndices[size.label] = currentDataCol++;
                        }
                    });
                }

                const processed = [];
                let currentRow = null;

                for (let i = headerRowIndex + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length < 2) continue;

                    const rawCode = row[codeIdx];
                    const rawName = row[nameIdx];

                    // Identify new item (has code)
                    if (rawCode && String(rawCode).trim().length > 0) {
                        currentRow = {
                            code: String(rawCode).trim(),
                            name: rawName ? String(rawName).trim() : '',
                            stock: {}
                        };
                        
                        // Read stock data
                        sizeMap.forEach(size => {
                            const colIdx = columnIndices[size.label];
                            if (colIdx !== undefined && colIdx < row.length) {
                                const val = parseFloat(String(row[colIdx]).replace(/,/g, ''));
                                currentRow.stock[size.label] = !isNaN(val) ? val : 0;
                            } else {
                                currentRow.stock[size.label] = 0;
                            }
                        });
                        
                        processed.push(currentRow);
                    } else if (currentRow) {
                        // Merge rows logic
                         sizeMap.forEach(size => {
                            const colIdx = columnIndices[size.label];
                            if (colIdx !== undefined && colIdx < row.length) {
                                const val = parseFloat(String(row[colIdx]).replace(/,/g, ''));
                                if (!isNaN(val)) currentRow.stock[size.label] += val;
                            }
                        });
                    }
                }
                return processed;
            };

            const handleInputChange = (e) => {
                const val = e.target.value;
                setSearchQuery(val);
                if (val.length > 1) {
                    const lower = val.toLowerCase();
                    setSuggestions(data.filter(item => 
                        item.code.toLowerCase().includes(lower) || 
                        item.name.toLowerCase().includes(lower)
                    ).slice(0, 10));
                    setShowSuggestions(true);
                } else {
                    setSuggestions([]);
                    setShowSuggestions(false);
                }
            };

            const handleSuggestionClick = (item) => {
                setSearchQuery(item.code);
                setSearchResult(item);
                setError('');
                setSuggestions([]);
                setShowSuggestions(false);
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if (!searchQuery.trim()) return;
                const query = searchQuery.trim().toLowerCase();
                
                let found = data.find(item => item.code.toLowerCase() === query);
                if (!found) found = data.find(item => item.code.toLowerCase().includes(query));
                
                if (found) { setSearchResult(found); setError(''); }
                else { setSearchResult(null); setError(`ไม่พบรหัส: ${searchQuery}`); }
                setShowSuggestions(false);
            };

            return (
                <div className="pt-20 px-5 pb-40 fade-in h-full flex flex-col">
                    <div className="flex items-center gap-3 mb-6">
                        <button onClick={onBack} className={`p-2 rounded-full border bg-white ${theme.border} ${theme.textSub}`}>
                            <Icons.ChevronDown className="rotate-90" size={20} />
                        </button>
                        <h2 className={`text-xl font-bold ${theme.textMain}`}>เช็คสต็อกมู่ลี่ไม้</h2>
                    </div>

                    <div className={`bg-white rounded-[2rem] p-6 shadow-sm border ${theme.border} mb-6 relative`}>
                        <form onSubmit={handleSearch} className="relative">
                            <input 
                                type="text" 
                                value={searchQuery}
                                onChange={handleInputChange}
                                onFocus={() => searchQuery.length > 1 && setShowSuggestions(true)}
                                placeholder="พิมพ์รหัสสินค้า (เช่น B35-36)" 
                                className={`input-apple w-full bg-slate-50 border border-slate-200 rounded-xl py-4 pl-12 pr-4 font-bold text-lg ${theme.textMain} placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-100`}
                            />
                            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                                <Icons.Box size={24} />
                            </div>
                            <button 
                                type="submit"
                                className={`absolute right-2 top-2 bottom-2 px-4 rounded-xl font-bold text-sm transition-colors ${theme.btnPrimary} flex items-center justify-center`}
                                disabled={loading}
                            >
                                {loading ? '...' : 'ค้นหา'}
                            </button>
                        </form>
                        
                        {/* View All Button */}
                        <button onClick={() => setShowAll(true)} disabled={loading || data.length === 0} className={`w-full mt-3 py-3 rounded-xl font-bold text-sm transition-colors border ${theme.border} ${theme.textSub} bg-white flex items-center justify-center gap-2 hover:bg-slate-50 disabled:opacity-50`}>
                            <Icons.FileText size={16}/> ดูตารางสต็อกทั้งหมด ({data.length})
                        </button>
                        
                        {/* Suggestions List */}
                        {showSuggestions && suggestions.length > 0 && (
                            <div className="absolute top-16 left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden max-h-60 overflow-y-auto">
                                {suggestions.map((item, idx) => (
                                    <div 
                                        key={idx}
                                        onClick={() => handleSuggestionClick(item)}
                                        className="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 last:border-0 flex justify-between items-center transition-colors"
                                    >
                                        <div className="flex flex-col">
                                            <span className="font-bold text-slate-700">{item.code}</span>
                                            <span className="text-[10px] text-slate-400">{item.name}</span>
                                        </div>
                                        <span className="text-xs text-slate-400">เลือก</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {error && <div className="mt-3 text-red-500 text-sm font-bold flex items-center gap-2"><Icons.AlertCircle size={16}/> {error}</div>}
                    </div>

                    {/* View All Modal */}
                    {showAll && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4 fade-in">
                            <div className={`bg-white rounded-[2rem] w-full max-w-5xl h-[85vh] flex flex-col shadow-2xl overflow-hidden scale-in ${theme.textMain}`}>
                                 <div className="p-5 border-b flex justify-between items-center bg-slate-50/80 backdrop-blur-md">
                                    <h3 className="font-bold text-lg">สต็อกทั้งหมด ({data.length})</h3>
                                    <button onClick={() => setShowAll(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><Icons.X size={24} /></button>
                                 </div>
                                 <div className="flex-1 overflow-auto p-0">
                                    <table className="w-full text-sm border-collapse border border-slate-200">
                                        <thead className="bg-slate-100 sticky top-0 shadow-sm z-10 text-slate-600">
                                            <tr>
                                                <th className="p-3 text-left bg-slate-100 min-w-[150px] border border-slate-300">สินค้า (รหัส/ชื่อ)</th>
                                                {sizeMap.map((col, i) => <th key={i} className="p-3 text-center whitespace-nowrap bg-slate-100 border border-slate-300">{col.label}</th>)}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {data.filter(item => item.name !== 'Unknown').map((item, i) => (
                                                <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                    <td className="p-3 border border-slate-200 align-top">
                                                        <div className="text-lg font-black text-slate-800 font-mono tracking-tight">{item.code}</div>
                                                        <div className="text-xs text-slate-500 mt-0.5">{item.name}</div>
                                                    </td>
                                                    {sizeMap.map((col, j) => {
                                                        const val = item.stock[col.label];
                                                        const hasStock = val > 0;
                                                        return <td key={j} className={`p-3 text-center border border-slate-200 align-middle ${hasStock ? 'text-green-600 font-bold bg-green-50/20' : 'bg-red-50/10'}`}>
                                                            {hasStock ? val : <span className="text-red-500 text-[10px] font-bold">สินค้าหมด</span>}
                                                        </td>
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                 </div>
                            </div>
                        </div>
                    )}

                    {searchResult && (
                        <div className="animate-scale-in">
                            <div className={`bg-white rounded-[2rem] overflow-hidden shadow-lg border ${theme.border}`}>
                                <div className={`${theme.bgSoft} p-5 border-b border-white/50`}>
                                    <h3 className={`text-4xl font-black ${theme.textMain} font-mono tracking-tight`}>{searchResult.code}</h3>
                                    <p className={`text-sm ${theme.textSub} mt-2 font-medium`}>{searchResult.name}</p>
                                </div>
                                <div className="p-5 grid grid-cols-3 gap-3">
                                    {sizeMap.map((col, i) => { 
                                        const val = searchResult.stock[col.label];
                                        const hasStock = val > 0; 
                                        return (
                                            <div key={i} className={`relative p-4 rounded-2xl border transition-all duration-300 hover:shadow-md ${hasStock ? 'bg-white border-green-200 shadow-sm' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">ความกว้าง</span>
                                                    <span className={`w-2 h-2 rounded-full ${hasStock ? 'bg-green-500' : 'bg-slate-300'}`}></span>
                                                </div>
                                                <div className="text-lg font-bold text-slate-700">{col.label}</div>
                                                <div className="mt-3 flex items-end justify-between">
                                                    {hasStock ? 
                                                        <span className="text-3xl font-black tracking-tighter text-slate-800">{val}</span> : 
                                                        <span className="text-lg font-bold text-red-500">สินค้าหมด</span>
                                                    }
                                                </div>
                                            </div>
                                        ) 
                                    })}
                                </div>
                                {showDebug && <div className="p-4 bg-slate-800 text-white text-xs"><pre>{JSON.stringify(searchResult, null, 2)}</pre></div>}
                                <div className="text-center p-2"><button onClick={() => setShowDebug(!showDebug)} className="text-[10px] text-slate-400 underline">{showDebug ? 'Hide' : 'Debug'}</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const RollerStockChecker = ({ theme, onBack }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchResult, setSearchResult] = useState(null);
            const [error, setError] = useState('');
            const [showDebug, setShowDebug] = useState(false);
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAll, setShowAll] = useState(false);

            const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1019928538&single=true&output=csv';

            useEffect(() => { setLoading(true); Papa.parse(SHEET_URL, { download: true, header: false, skipEmptyLines: true, complete: (res) => { setData(res.data); setLoading(false); }, error: () => setLoading(false) }); }, []);

            const handleInputChange = (e) => {
                const val = e.target.value; setSearchQuery(val);
                if (val.length > 1) {
                    const lower = val.toLowerCase();
                    setSuggestions(data.filter(row => String(row[0]).toLowerCase().includes(lower)).slice(0, 10));
                    setShowSuggestions(true);
                } else { setSuggestions([]); setShowSuggestions(false); }
            };

            const handleSearch = (e) => { e.preventDefault(); const found = data.find(row => String(row[0]).toLowerCase().includes(searchQuery.toLowerCase())); if(found){ setSearchResult(found); setError(''); } else { setSearchResult(null); setError('ไม่พบ'); } setShowSuggestions(false); };

            return (
                <div className="pt-20 px-5 pb-40 fade-in h-full flex flex-col">
                    <div className="flex items-center gap-3 mb-6"><button onClick={onBack} className={`p-2 rounded-full border bg-white ${theme.border} ${theme.textSub}`}><Icons.ChevronDown className="rotate-90" size={20} /></button><h2 className={`text-xl font-bold ${theme.textMain}`}>เช็คสต็อกม่านม้วน</h2></div>
                    <div className={`bg-white rounded-[2rem] p-6 shadow-sm border ${theme.border} mb-6 relative`}><form onSubmit={handleSearch} className="relative"><input type="text" value={searchQuery} onChange={handleInputChange} onFocus={() => searchQuery.length > 1 && setShowSuggestions(true)} placeholder="พิมพ์รหัสสินค้า..." className={`input-apple w-full bg-slate-50 border border-slate-200 rounded-xl py-4 pl-12 pr-4 font-bold text-lg ${theme.textMain} placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-100`} /><div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Box size={24} /></div><button type="submit" className={`absolute right-2 top-2 bottom-2 px-4 rounded-xl font-bold text-sm transition-colors ${theme.btnPrimary} flex items-center justify-center`} disabled={loading}>{loading ? '...' : 'ค้นหา'}</button></form>
                    {/* View All Button */}
                    <button onClick={() => setShowAll(true)} disabled={loading || data.length === 0} className={`w-full mt-3 py-3 rounded-xl font-bold text-sm transition-colors border ${theme.border} ${theme.textSub} bg-white flex items-center justify-center gap-2 hover:bg-slate-50 disabled:opacity-50`}>
                        <Icons.FileText size={16}/> ดูตารางสต็อกทั้งหมด ({data.length})
                    </button>
                    {showSuggestions && suggestions.length > 0 && (<div className="absolute top-16 left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden max-h-60 overflow-y-auto">{suggestions.map((row, idx) => (<div key={idx} onClick={() => { setSearchQuery(row[0]); setSearchResult(row); setShowSuggestions(false); }} className="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 flex justify-between items-center"><div className="flex flex-col"><span className="font-bold text-slate-700">{row[0]}</span><span className="text-[10px] text-slate-400">{row[1]}</span></div></div>))}</div>)}{error && <div className="mt-3 text-red-500 text-sm font-bold flex items-center gap-2"><Icons.AlertCircle size={16}/> {error}</div>}</div>
                    
                    {/* View All Modal */}
                    {showAll && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4 fade-in">
                            <div className={`bg-white rounded-[2rem] w-full max-w-4xl h-[85vh] flex flex-col shadow-2xl overflow-hidden scale-in ${theme.textMain}`}>
                                 <div className="p-5 border-b flex justify-between items-center bg-slate-50/80 backdrop-blur-md">
                                    <h3 className="font-bold text-lg">สต็อกทั้งหมด ({data.length})</h3>
                                    <button onClick={() => setShowAll(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><Icons.X size={24} /></button>
                                 </div>
                                 <div className="flex-1 overflow-auto p-0">
                                    <table className="w-full text-sm border-collapse border border-slate-200">
                                        <thead className="bg-slate-100 sticky top-0 shadow-sm z-10 text-slate-600">
                                            <tr>
                                                <th className="p-3 text-left bg-slate-100 border border-slate-300">รหัสสินค้า</th>
                                                <th className="p-3 text-left bg-slate-100 border border-slate-300">ชื่อสินค้า</th>
                                                <th className="p-3 text-right bg-slate-100 border border-slate-300">คงเหลือ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {data.map((row, i) => {
                                                const qty = parseFloat(row[2]);
                                                const hasStock = qty > 0;
                                                return (
                                                <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                    <td className="p-3 font-bold text-slate-700 font-mono border border-slate-200">{row[0]}</td>
                                                    <td className="p-3 text-slate-600 border border-slate-200">{row[1]}</td>
                                                    <td className={`p-3 text-right font-bold border border-slate-200 ${hasStock ? 'text-green-600' : 'bg-red-50/20'}`}>
                                                        {hasStock ? row[2] : <span className="text-red-500 text-xs font-bold">สินค้าหมด</span>}
                                                    </td>
                                                </tr>
                                            )})}
                                        </tbody>
                                    </table>
                                 </div>
                            </div>
                        </div>
                    )}

                    {searchResult && (
                        <div className="animate-scale-in">
                            <div className={`bg-white rounded-[2rem] overflow-hidden shadow-lg border ${theme.border} text-center p-8`}>
                                <h3 className={`text-sm font-bold uppercase tracking-wider ${theme.textSub} mb-2`}>สินค้า</h3>
                                <div className={`text-3xl font-bold ${theme.textMain} mb-6`}>{searchResult[1]}</div>
                                <div className="w-full h-px bg-slate-100 mb-6"></div>
                                <h3 className={`text-sm font-bold uppercase tracking-wider ${theme.textSub} mb-2`}>จำนวนคงเหลือ</h3>
                                {parseFloat(searchResult[2]) > 0 ? 
                                    <div className={`text-6xl font-black ${theme.highlight}`}>{searchResult[2]}</div> : 
                                    <div className="text-4xl font-bold text-red-500">สินค้าหมด</div>
                                }
                                <div className="mt-2 text-sm text-slate-400">หน่วย (ถ้ามี)</div>
                                {showDebug && <div className="mt-8 p-4 bg-slate-800 text-white text-xs text-left"><pre>{JSON.stringify(searchResult, null, 2)}</pre></div>}
                                <button onClick={() => setShowDebug(!showDebug)} className="mt-4 text-[10px] text-slate-300 underline">{showDebug ? 'Hide' : 'Debug'}</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AluminumStockChecker = ({ theme, onBack }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchResult, setSearchResult] = useState(null);
            const [error, setError] = useState('');
            const [showDebug, setShowDebug] = useState(false);
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAll, setShowAll] = useState(false);

            const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1880232984&single=true&output=csv';

            useEffect(() => { setLoading(true); Papa.parse(SHEET_URL, { download: true, header: false, skipEmptyLines: true, complete: (res) => { setData(res.data); setLoading(false); }, error: () => setLoading(false) }); }, []);

            const handleInputChange = (e) => {
                const val = e.target.value; setSearchQuery(val);
                if (val.length > 1) {
                    const lower = val.toLowerCase();
                    setSuggestions(data.filter(row => String(row[0]).toLowerCase().includes(lower)).slice(0, 10));
                    setShowSuggestions(true);
                } else { setSuggestions([]); setShowSuggestions(false); }
            };

            const handleSearch = (e) => { e.preventDefault(); const found = data.find(row => String(row[0]).toLowerCase().includes(searchQuery.toLowerCase())); if(found){ setSearchResult(found); setError(''); } else { setSearchResult(null); setError('ไม่พบ'); } setShowSuggestions(false); };

            return (
                <div className="pt-20 px-5 pb-40 fade-in h-full flex flex-col">
                    <div className="flex items-center gap-3 mb-6"><button onClick={onBack} className={`p-2 rounded-full border bg-white ${theme.border} ${theme.textSub}`}><Icons.ChevronDown className="rotate-90" size={20} /></button><h2 className={`text-xl font-bold ${theme.textMain}`}>เช็คสต็อกมู่ลี่อลูมิเนียม</h2></div>
                    <div className={`bg-white rounded-[2rem] p-6 shadow-sm border ${theme.border} mb-6 relative`}><form onSubmit={handleSearch} className="relative"><input type="text" value={searchQuery} onChange={handleInputChange} onFocus={() => searchQuery.length > 1 && setShowSuggestions(true)} placeholder="พิมพ์รหัสสินค้า..." className={`input-apple w-full bg-slate-50 border border-slate-200 rounded-xl py-4 pl-12 pr-4 font-bold text-lg ${theme.textMain} placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-100`} /><div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Box size={24} /></div><button type="submit" className={`absolute right-2 top-2 bottom-2 px-4 rounded-xl font-bold text-sm transition-colors ${theme.btnPrimary} flex items-center justify-center`} disabled={loading}>{loading ? '...' : 'ค้นหา'}</button></form>
                    {/* View All Button */}
                    <button onClick={() => setShowAll(true)} disabled={loading || data.length === 0} className={`w-full mt-3 py-3 rounded-xl font-bold text-sm transition-colors border ${theme.border} ${theme.textSub} bg-white flex items-center justify-center gap-2 hover:bg-slate-50 disabled:opacity-50`}>
                        <Icons.FileText size={16}/> ดูตารางสต็อกทั้งหมด ({data.length})
                    </button>
                    {showSuggestions && suggestions.length > 0 && (<div className="absolute top-16 left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden max-h-60 overflow-y-auto">{suggestions.map((row, idx) => (<div key={idx} onClick={() => { setSearchQuery(row[0]); setSearchResult(row); setShowSuggestions(false); }} className="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 flex justify-between items-center"><div className="flex flex-col"><span className="font-bold text-slate-700">{row[0]}</span><span className="text-[10px] text-slate-400">{row[1]}</span></div></div>))}</div>)}{error && <div className="mt-3 text-red-500 text-sm font-bold flex items-center gap-2"><Icons.AlertCircle size={16}/> {error}</div>}</div>
                    
                    {/* View All Modal */}
                    {showAll && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4 fade-in">
                            <div className={`bg-white rounded-[2rem] w-full max-w-4xl h-[85vh] flex flex-col shadow-2xl overflow-hidden scale-in ${theme.textMain}`}>
                                 <div className="p-5 border-b flex justify-between items-center bg-slate-50/80 backdrop-blur-md">
                                    <h3 className="font-bold text-lg">สต็อกทั้งหมด ({data.length})</h3>
                                    <button onClick={() => setShowAll(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><Icons.X size={24} /></button>
                                 </div>
                                 <div className="flex-1 overflow-auto p-0">
                                    <table className="w-full text-sm border-collapse border border-slate-200">
                                        <thead className="bg-slate-100 sticky top-0 shadow-sm z-10 text-slate-600">
                                            <tr>
                                                <th className="p-3 text-left bg-slate-100 border border-slate-300">รหัสสินค้า</th>
                                                <th className="p-3 text-left bg-slate-100 border border-slate-300">ชื่อสินค้า</th>
                                                <th className="p-3 text-right bg-slate-100 border border-slate-300">คงเหลือ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {data.map((row, i) => {
                                                const qty = parseFloat(row[2]);
                                                const hasStock = qty > 0;
                                                return (
                                                <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                    <td className="p-3 font-bold text-slate-700 font-mono border border-slate-200">{row[0]}</td>
                                                    <td className="p-3 text-slate-600 border border-slate-200">{row[1]}</td>
                                                    <td className={`p-3 text-right font-bold border border-slate-200 ${hasStock ? 'text-green-600' : 'bg-red-50/20'}`}>
                                                        {hasStock ? row[2] : <span className="text-red-500 text-xs font-bold">สินค้าหมด</span>}
                                                    </td>
                                                </tr>
                                            )})}
                                        </tbody>
                                    </table>
                                 </div>
                            </div>
                        </div>
                    )}

                    {searchResult && (
                        <div className="animate-scale-in">
                            <div className={`bg-white rounded-[2rem] overflow-hidden shadow-lg border ${theme.border} text-center p-8`}>
                                <h3 className={`text-sm font-bold uppercase tracking-wider ${theme.textSub} mb-2`}>สินค้า</h3>
                                <div className={`text-3xl font-bold ${theme.textMain} mb-6`}>{searchResult[1]}</div>
                                <div className="w-full h-px bg-slate-100 mb-6"></div>
                                <h3 className={`text-sm font-bold uppercase tracking-wider ${theme.textSub} mb-2`}>จำนวนคงเหลือ</h3>
                                {parseFloat(searchResult[2]) > 0 ? 
                                    <div className={`text-6xl font-black ${theme.highlight}`}>{searchResult[2]}</div> : 
                                    <div className="text-4xl font-bold text-red-500">สินค้าหมด</div>
                                }
                                <div className="mt-2 text-sm text-slate-400">หน่วย (ถ้ามี)</div>
                                {showDebug && <div className="mt-8 p-4 bg-slate-800 text-white text-xs text-left"><pre>{JSON.stringify(searchResult, null, 2)}</pre></div>}
                                <button onClick={() => setShowDebug(!showDebug)} className="mt-4 text-[10px] text-slate-300 underline">{showDebug ? 'Hide' : 'Debug'}</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const PVCStockChecker = ({ theme, onBack }) => {
            const [searchQuery, setSearchQuery] = useState('');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchResult, setSearchResult] = useState(null);
            const [error, setError] = useState('');
            const [showDebug, setShowDebug] = useState(false);
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showAll, setShowAll] = useState(false);

            const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1230787558&single=true&output=csv';

            // Fixed columns definition for PVC
            const heightColumns = [
                '2.00', '2.20', '2.40', '2.60', '2.80', '3.00', 
                '3.20', '3.30', '3.50', '3.70', '3.75'
            ];

            useEffect(() => {
                setLoading(true);
                // Use header: false to handle duplicate headers manually and prevent data loss
                Papa.parse(SHEET_URL, {
                    download: true, header: false, skipEmptyLines: true,
                    complete: (results) => { setData(preprocessData(results.data)); setLoading(false); },
                    error: () => { setError('ไม่สามารถดึงข้อมูลสต็อกได้'); setLoading(false); }
                });
            }, []);

            const preprocessData = (rows) => {
                if (!rows || rows.length < 2) return [];
                
                // 1. Hunt for the Header Row and Column Indices
                let headerRowIndex = -1;
                let codeIdx = -1;
                let nameIdx = -1;
                let heightStartIdx = -1;

                // Look through first 5 rows for a known header pattern
                for (let i = 0; i < Math.min(rows.length, 5); i++) {
                    // Normalize cell content for checking
                    const row = rows[i].map(cell => String(cell).trim().toLowerCase());
                    
                    // Look for indicators
                    const hIdx = row.findIndex(c => c.includes('2.00') || c.includes('ความสูง'));
                    const cIdx = row.findIndex(c => c === 'code' || c === 'รหัส' || c.includes('product code') || c.includes('รหัสสินค้า'));
                    
                    if (hIdx !== -1 || cIdx !== -1) {
                        headerRowIndex = i;
                        // If 2.00 is found, use it. If not, guess it's column 2 or 3 depending on name/code
                        heightStartIdx = hIdx !== -1 ? hIdx : 2; 
                        
                        // If Code found, use it. Else default to 0
                        codeIdx = cIdx !== -1 ? cIdx : 0;
                        
                        // Try to find name (Name, Product Name, ชื่อ)
                        const nIdx = row.findIndex(c => c === 'name' || c === 'ชื่อ' || c.includes('product name') || c.includes('ชื่อสินค้า'));
                        nameIdx = nIdx !== -1 ? nIdx : (codeIdx === 0 ? 1 : 0);
                        
                        // Safety: If Name and Code are same (not found), separate them
                        if (nameIdx === codeIdx) nameIdx = codeIdx + 1;
                        
                        break;
                    }
                }

                // 2. Fallback if NO header detected (The "Blind Read" mode)
                if (headerRowIndex === -1) {
                    console.warn("No header detected, using fallback indices.");
                    headerRowIndex = 0; // Assume first row is header
                    codeIdx = 0;        // Col A = Code
                    nameIdx = 1;        // Col B = Name
                    heightStartIdx = 2; // Col C = Start of Data (2.00)
                }

                const processed = [];
                let currentRow = null;

                // 3. Process Data Rows
                for (let i = headerRowIndex + 1; i < rows.length; i++) {
                    const row = rows[i];
                    // Skip empty rows or rows that are too short to contain data
                    if (!row || row.length < 2) continue;

                    const rawCode = row[codeIdx];
                    const rawName = row[nameIdx];

                    // Check if this row starts a new item (has a Code that isn't empty)
                    if (rawCode && String(rawCode).trim().length > 0) {
                        currentRow = {
                            code: String(rawCode).trim(),
                            name: rawName ? String(rawName).trim() : 'Unknown',
                            stock: {}
                        };
                        
                        // Map height columns strictly by order relative to start index
                        heightColumns.forEach((hKey, index) => {
                            const colIdx = heightStartIdx + index;
                            if (colIdx < row.length) {
                                // Clean the value (remove commas, handle non-numeric)
                                const valStr = String(row[colIdx] || '').replace(/,/g, '').trim();
                                const val = parseFloat(valStr);
                                currentRow.stock[hKey] = !isNaN(val) ? val : 0;
                            } else {
                                currentRow.stock[hKey] = 0;
                            }
                        });
                        
                        processed.push(currentRow);
                    } else if (currentRow) {
                        // Merge logic for rows without code (continuation lines)
                        // Useful if data is split across multiple rows for the same item
                         heightColumns.forEach((hKey, index) => {
                            const colIdx = heightStartIdx + index;
                            if (colIdx < row.length) {
                                const valStr = String(row[colIdx] || '').replace(/,/g, '').trim();
                                const val = parseFloat(valStr);
                                if (!isNaN(val)) {
                                    currentRow.stock[hKey] = (currentRow.stock[hKey] || 0) + val;
                                }
                            }
                        });
                    }
                }
                
                return processed;
            };

            const handleInputChange = (e) => { 
                const val = e.target.value; 
                setSearchQuery(val); 
                if (val.length > 1) { 
                    const lower = val.toLowerCase(); 
                    setSuggestions(data.filter(item => 
                        item.code.toLowerCase().includes(lower) || 
                        item.name.toLowerCase().includes(lower)
                    ).slice(0, 10)); 
                    setShowSuggestions(true); 
                } else { 
                    setSuggestions([]); setShowSuggestions(false); 
                } 
            };

            const handleSearch = (e) => { 
                e.preventDefault(); 
                const query = searchQuery.toLowerCase(); 
                // Exact match first, then partial
                let found = data.find(item => item.code.toLowerCase() === query);
                if (!found) found = data.find(item => item.code.toLowerCase().includes(query));
                
                if(found) { setSearchResult(found); setError(''); } 
                else { setSearchResult(null); setError('ไม่พบข้อมูล'); } 
                setShowSuggestions(false); 
            };

            return (
                <div className="pt-20 px-5 pb-40 fade-in h-full flex flex-col">
                    <div className="flex items-center gap-3 mb-6"><button onClick={onBack} className={`p-2 rounded-full border bg-white ${theme.border} ${theme.textSub}`}><Icons.ChevronDown className="rotate-90" size={20} /></button><h2 className={`text-xl font-bold ${theme.textMain}`}>เช็คสต็อกฉาก PVC</h2></div>
                    
                    {/* Search Section */}
                    <div className={`bg-white rounded-[2rem] p-6 shadow-sm border ${theme.border} mb-6 relative`}>
                        <form onSubmit={handleSearch} className="relative">
                            <input type="text" value={searchQuery} onChange={handleInputChange} onFocus={() => searchQuery.length > 1 && setShowSuggestions(true)} placeholder="พิมพ์รหัสสินค้า..." className={`input-apple w-full bg-slate-50 border border-slate-200 rounded-xl py-4 pl-12 pr-4 font-bold text-lg ${theme.textMain} placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-100`} />
                            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Box size={24} /></div>
                            <button type="submit" className={`absolute right-2 top-2 bottom-2 px-4 rounded-xl font-bold text-sm transition-colors ${theme.btnPrimary} flex items-center justify-center`} disabled={loading}>{loading ? '...' : 'ค้นหา'}</button>
                        </form>
                        <button onClick={() => setShowAll(true)} disabled={loading || data.length === 0} className={`w-full mt-3 py-3 rounded-xl font-bold text-sm transition-colors border ${theme.border} ${theme.textSub} bg-white flex items-center justify-center gap-2 hover:bg-slate-50 disabled:opacity-50`}><Icons.FileText size={16}/> ดูตารางสต็อกทั้งหมด ({data.length})</button>
                        
                        {/* Suggestions */}
                        {showSuggestions && suggestions.length > 0 && (
                            <div className="absolute top-16 left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden max-h-60 overflow-y-auto">
                                {suggestions.map((item, idx) => (
                                    <div key={idx} onClick={() => { setSearchQuery(item.code); setSearchResult(item); setShowSuggestions(false); }} className="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 flex justify-between items-center">
                                        <div className="flex flex-col"><span className="font-bold text-slate-700">{item.code}</span><span className="text-[10px] text-slate-400">{item.name}</span></div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {error && <div className="mt-3 text-red-500 text-sm font-bold flex items-center gap-2"><Icons.AlertCircle size={16}/> {error}</div>}
                    </div>
                    
                    {/* View All Modal */}
                    {showAll && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4 fade-in">
                            <div className={`bg-white rounded-[2rem] w-full max-w-6xl h-[85vh] flex flex-col shadow-2xl overflow-hidden scale-in ${theme.textMain}`}>
                                 <div className="p-5 border-b flex justify-between items-center bg-slate-50/80 backdrop-blur-md">
                                    <h3 className="font-bold text-lg">สต็อกทั้งหมด ({data.length})</h3>
                                    <button onClick={() => setShowAll(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><Icons.X size={24} /></button>
                                 </div>
                                 <div className="flex-1 overflow-auto p-0">
                                    <table className="w-full text-sm border-collapse border border-slate-200">
                                        <thead className="bg-slate-100 sticky top-0 shadow-sm z-10 text-slate-600">
                                            <tr>
                                                <th className="p-3 text-left bg-slate-100 min-w-[150px] border border-slate-300">สินค้า (รหัส/ชื่อ)</th>
                                                {heightColumns.map((h, i) => <th key={i} className="p-3 text-center whitespace-nowrap bg-slate-100 border border-slate-300">{h} ม.</th>)}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {data.filter(item => item.name !== 'Unknown').map((item, i) => (
                                                <tr key={i} className="hover:bg-slate-50 transition-colors">
                                                    <td className="p-3 border border-slate-200 align-top">
                                                        <div className="text-lg font-black text-slate-800 font-mono tracking-tight">{item.code}</div>
                                                        <div className="text-xs text-slate-500 mt-0.5">{item.name}</div>
                                                    </td>
                                                    {heightColumns.map((hKey, j) => {
                                                        const val = item.stock[hKey];
                                                        const hasStock = val > 0;
                                                        return <td key={j} className={`p-3 text-center border border-slate-200 align-middle ${hasStock ? 'text-green-600 font-bold bg-green-50/20' : 'bg-red-50/10'}`}>
                                                            {hasStock ? val : <span className="text-red-500 text-[10px] font-bold">สินค้าหมด</span>}
                                                        </td>
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                 </div>
                            </div>
                        </div>
                    )}

                    {/* Single Result View */}
                    {searchResult && (
                        <div className="animate-scale-in">
                            <div className={`bg-white rounded-[2rem] overflow-hidden shadow-lg border ${theme.border}`}>
                                <div className={`${theme.bgSoft} p-5 border-b border-white/50`}>
                                    <h3 className={`text-4xl font-black ${theme.textMain} font-mono tracking-tight`}>{searchResult.code}</h3>
                                    <p className={`text-sm ${theme.textSub} mt-2 font-medium`}>{searchResult.name}</p>
                                </div>
                                <div className="p-5 grid grid-cols-3 gap-3">
                                    {heightColumns.map((hKey, index) => {
                                        const val = searchResult.stock[hKey];
                                        const hasStock = val > 0;
                                        return (
                                            <div key={index} className={`relative p-4 rounded-2xl border transition-all duration-300 hover:shadow-md ${hasStock ? 'bg-white border-green-200 shadow-sm' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                                                <div className="flex justify-between items-start mb-2"><span className="text-xs font-bold text-slate-400 uppercase tracking-wider">ความสูง</span><span className={`w-2 h-2 rounded-full ${hasStock ? 'bg-green-500' : 'bg-slate-300'}`}></span></div>
                                                <div className="text-lg font-bold text-slate-700">{hKey} ม.</div>
                                                <div className="mt-3 flex items-end justify-between">
                                                    {hasStock ? 
                                                        <span className="text-3xl font-black tracking-tighter text-slate-800">{val}</span> : 
                                                        <span className="text-lg font-bold text-red-500">สินค้าหมด</span>
                                                    }
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                {showDebug && <div className="p-4 bg-slate-800 text-white text-xs overflow-x-auto"><pre>{JSON.stringify(searchResult, null, 2)}</pre></div>}
                                <div className="text-center p-2"><button onClick={() => setShowDebug(!showDebug)} className="text-[10px] text-slate-400 underline">{showDebug ? 'Hide' : 'Debug'}</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const StockPage = ({ theme }) => {
            const [subPage, setSubPage] = useState(null);
            if (subPage === 'wood') return <WoodStockChecker theme={theme} onBack={() => setSubPage(null)} />;
            if (subPage === 'roller') return <RollerStockChecker theme={theme} onBack={() => setSubPage(null)} />;
            if (subPage === 'aluminum') return <AluminumStockChecker theme={theme} onBack={() => setSubPage(null)} />;
            if (subPage === 'pvc') return <PVCStockChecker theme={theme} onBack={() => setSubPage(null)} />;
            return (
                <div className="pt-24 px-5 pb-40 fade-in h-full flex flex-col">
                    <h2 className={`text-2xl font-bold mb-6 ${theme.textMain}`}>เช็คสต็อกสินค้า</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={() => setSubPage('wood')} className={`bg-white p-6 rounded-2xl shadow-sm border border-white hover:shadow-md transition-all flex flex-col items-center gap-3 group`}><div className={`p-4 rounded-full ${theme.bgSoft} ${theme.primary}`}><Icons.Blinds size={32} /></div><span className={`font-bold ${theme.textMain}`}>มู่ลี่ไม้</span></button>
                        <button onClick={() => setSubPage('roller')} className={`bg-white p-6 rounded-2xl shadow-sm border border-white hover:shadow-md transition-all flex flex-col items-center gap-3 group`}><div className={`p-4 rounded-full ${theme.bgSoft} ${theme.primary}`}><Icons.Roller size={32} /></div><span className={`font-bold ${theme.textMain}`}>ม่านม้วน</span></button>
                        <button onClick={() => setSubPage('aluminum')} className={`bg-white p-6 rounded-2xl shadow-sm border border-white hover:shadow-md transition-all flex flex-col items-center gap-3 group`}><div className={`p-4 rounded-full ${theme.bgSoft} ${theme.primary}`}><Icons.Blinds size={32} /></div><span className={`font-bold ${theme.textMain}`}>มู่ลี่อลูมิเนียม</span></button>
                        <button onClick={() => setSubPage('pvc')} className={`bg-white p-6 rounded-2xl shadow-sm border border-white hover:shadow-md transition-all flex flex-col items-center gap-3 group`}><div className={`p-4 rounded-full ${theme.bgSoft} ${theme.primary}`}><Icons.Fold size={32} /></div><span className={`font-bold ${theme.textMain}`}>ฉาก PVC</span></button>
                    </div>
                </div>
            );
        };
        
        const CalculatorPage = ({ config, items, setItems, user, onLogin, userProfile, theme, aluminumPrices }) => {
            const [calcMode, setCalcMode] = useState('external');
            const [alumSystem, setAlumSystem] = useState('standard');
            const [pvcType, setPvcType] = useState('8.5_solid'); 
            const [pvcOpenType, setPvcOpenType] = useState('side_1');
            const [pvcCustomPrice, setPvcCustomPrice] = useState('');
            const [railType, setRailType] = useState('hospital'); // State for Rail Type
            const [showQuote, setShowQuote] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [formData, setFormData] = useState({ width: '', height: '', price: '', qty: '1', side: 'ขวา', woodType: 'BASSWOOD' });
            
            // --- NEW: Installation Fee States ---
            const [useInstallFee, setUseInstallFee] = useState(false);
            const [installFee, setInstallFee] = useState('');

            // --- NEW: Editing State ---
            const [editingId, setEditingId] = useState(null);

            const availableModes = useMemo(() => {
                const modes = [];
                if (config.showExternal) modes.push({ id: 'external', label: 'ม่านภายนอก', icon: <Icons.Sun size={24} /> });
                if (config.showInternal) modes.push({ id: 'internal', label: 'ม่านภายใน', icon: <Icons.Roller size={24} /> });
                if (config.showWooden) modes.push({ id: 'wooden', label: 'มู่ลี่ไม้', icon: <Icons.Blinds size={24} /> });
                if (config.showAluminum) modes.push({ id: 'aluminum', label: 'มู่ลี่อลูมิเนียม', icon: <Icons.Blinds size={24} /> });
                if (config.showPVC) modes.push({ id: 'pvc', label: 'ฉากกั้นห้อง PVC', icon: <Icons.Fold size={24} /> }); 
                if (config.showRail) modes.push({ id: 'rail', label: 'รางม่าน', icon: <Icon path={<line x1="2" y1="12" x2="22" y2="12"></line>} size={24} /> }); // New Menu
                return modes;
            }, [config]);

            useEffect(() => { if (availableModes.length > 0 && !availableModes.find(m => m.id === calcMode)) setCalcMode(availableModes[0].id); }, [availableModes, calcMode]);
            useEffect(() => { if (errorMsg) setErrorMsg(''); }, [formData]);

            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const roundToStep = (val) => Math.round(val / 10) * 10;
            const getPvcCalcHeight = (h_m) => { if (h_m < 2.00) return 2.00; if (h_m <= 2.01) return 2.00; if (h_m <= 2.21) return 2.20; if (h_m <= 2.41) return 2.40; if (h_m <= 2.61) return 2.60; if (h_m <= 2.81) return 2.80; if (h_m <= 3.01) return 3.00; if (h_m <= 3.31) return 3.30; if (h_m <= 3.51) return 3.50; if (h_m <= 3.70) return 3.70; return h_m; };
            const getPvcCalcWidth = (w_m) => w_m < 1.00 ? 1.00 : w_m;

            const pvcPriceOptions = [ { id: '8.5_solid', label: 'ใบ 8.5cm แบบทึบ', price: config.pvc85SolidPrice }, { id: '8.5_japan', label: 'ใบ 8.5cm ญี่ปุ่น', price: config.pvc85JapanPrice }, { id: '10_solid', label: 'ใบ 10cm แบบทึบ', price: config.pvc10SolidPrice }, { id: '10_japan', label: 'ใบ 10cm ญี่ปุ่น', price: config.pvc10JapanPrice }, { id: 'euro_la', label: 'ใบ 12.3cm ยูโร LA', price: config.pvcEuroPrice }, { id: 'euro_lb', label: 'ใบ 12.3cm ยูโร LB', price: config.pvcEuroPrice }, { id: 'euro_zigzag', label: 'ใบ 12.3cm ยูโร สลับฟันปลา', price: config.pvcEuroPrice }, { id: 'custom', label: 'กำหนดราคาเอง', price: 'manual' } ];
            const pvcOpeningOptions = [ { id: 'side_1', label: 'เปิดข้าง 1 จุด' }, { id: 'side_2', label: 'เปิดข้าง 2 จุด' }, { id: 'center', label: 'เปิดกลาง' }, { id: 'center_3', label: 'เปิดกลาง 3 จุด' }, { id: 'center_4', label: 'เปิดกลาง 4 จุด' } ];
            
            // Rail Options
            const railOptions = [
                { id: 'hospital', label: 'รางโรงพยาบาล', price: config.railHospitalPrice, unit: 'เมตร' },
                { id: 'hospital_tape', label: 'รางโรงพยาบาลลอนเทป', price: config.railHospitalTapePrice, unit: 'เมตร' },
                { id: 'ceiling_bracket', label: 'แป๊ดยึดเพดาน', price: config.railCeilingBracketPrice, unit: 'ชุด' },
                { id: 'tes_white_black', label: 'รางลอนเทป TES (ขาว/ดำ)', price: config.railTesWhiteBlackPrice, unit: 'เมตร' },
                { id: 'tes_wood', label: 'รางลอนเทป TES (ลายไม้)', price: config.railTesWoodPrice, unit: 'เมตร' },
                { id: 'nano', label: 'รางลอนเทป NANO (เก็บเสียง)', price: config.railNanoPrice, unit: 'เมตร' },
                { id: 'm_manual', label: 'ราง M ระบบมือดึง', price: config.railMManualPrice, unit: 'เมตร' },
                { id: 'm_cord', label: 'ราง M ระบบเชือกดึง', price: config.railMCordPrice, unit: 'เมตร' },
            ];

            const handleEdit = (item) => {
                // Restore state from item.rawParams if available
                if (item.rawParams) {
                    const p = item.rawParams;
                    setCalcMode(p.calcMode);
                    setAlumSystem(p.alumSystem || 'standard');
                    setPvcType(p.pvcType || '8.5_solid');
                    setPvcOpenType(p.pvcOpenType || 'side_1');
                    setPvcCustomPrice(p.pvcCustomPrice || '');
                    setRailType(p.railType || 'hospital');
                    setFormData(p.formData);
                    setUseInstallFee(p.useInstallFee || false);
                    setInstallFee(p.installFee || '');
                } else {
                    // Fallback for old items without rawParams
                    setCalcMode(item.type);
                    setFormData({
                        width: item.w_cm,
                        height: item.h_cm,
                        price: item.unitPrice,
                        qty: item.qty,
                        side: item.side,
                        woodType: 'BASSWOOD' // Default fallback
                    });
                }
                setEditingId(item.id);
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelEdit = () => {
                setEditingId(null);
                setFormData({ width: '', height: '', price: '', qty: '1', side: 'ขวา', woodType: 'BASSWOOD' });
                setUseInstallFee(false);
                setInstallFee('');
                setPvcCustomPrice('');
            };

            const calculateItem = () => {
                const qty = parseInt(formData.qty);
                if (!qty) return setErrorMsg('กรุณาระบุจำนวน');
                
                // Get Installation Fee
                let installCost = 0;
                if (useInstallFee && installFee) {
                    installCost = parseFloat(installFee) || 0;
                }
                
                let price = 0; let totalPerUnit = 0; let details = {}; let typeName = "";
                let w_cm = parseFloat(formData.width) || 0;
                let h_cm = parseFloat(formData.height) || 0;

                if (calcMode === 'rail') {
                    const selectedRail = railOptions.find(r => r.id === railType);
                    if (!selectedRail) return;
                    
                    price = selectedRail.price;
                    typeName = selectedRail.label;
                    
                    if (railType === 'ceiling_bracket') {
                        totalPerUnit = price + installCost;
                        const mainFormula = `${price} บาท x 1 ชุด = ${formatCurrency(price)}`;
                        details = {
                            mainFormula: mainFormula,
                            sumFormula: `${formatCurrency(totalPerUnit)} x ${qty} ชุด = ${formatCurrency(totalPerUnit * qty)}`
                        };
                    } else {
                        if (!w_cm) return setErrorMsg('กรุณากรอกความกว้าง');
                        const w_m = w_cm / 100;
                        const pricePerSet = w_m * price;
                        totalPerUnit = pricePerSet + installCost;
                        
                        let formulaText = `${w_m.toFixed(2)}m x ${formatCurrency(price)} = ${formatCurrency(pricePerSet)}`;
                        if (installCost > 0) formulaText += ` + ติดตั้ง ${formatCurrency(installCost)}`;
                        
                        details = {
                            mainFormula: formulaText,
                            sumFormula: `${formatCurrency(totalPerUnit)} x ${qty} ชุด = ${formatCurrency(totalPerUnit * qty)}`
                        };
                    }
                } else if (calcMode === 'pvc') {
                    if (!w_cm || !h_cm) return setErrorMsg('กรุณากรอกข้อมูลให้ครบถ้วน');
                    const selectedPvc = pvcPriceOptions.find(p => p.id === pvcType);
                    let unitPrice = selectedPvc.price === 'manual' ? parseFloat(pvcCustomPrice) : selectedPvc.price;
                    if (!unitPrice) return setErrorMsg('กรุณากรอกราคาต่อตารางหลา');
                    const w_m_input = w_cm / 100; const h_m_input = h_cm / 100;
                    const w_calc = getPvcCalcWidth(w_m_input); const h_calc = getPvcCalcHeight(h_m_input);
                    const pricePerSet = w_calc * h_calc * 1.2 * unitPrice;
                    totalPerUnit = pricePerSet + installCost; // Add Install Cost
                    price = unitPrice; 
                    const openingLabel = pvcOpeningOptions.find(o => o.id === pvcOpenType)?.label || pvcOpenType;
                    typeName = `ฉากกั้นห้อง PVC (${selectedPvc.label}) - ${openingLabel}`;
                    
                    let formulaText = `${w_calc.toFixed(2)}m x ${h_calc.toFixed(2)}m x 1.2 x ${formatCurrency(unitPrice)} = ${formatCurrency(pricePerSet)}`;
                    if (installCost > 0) {
                        formulaText += ` + ติดตั้ง ${formatCurrency(installCost)} = ${formatCurrency(totalPerUnit)}`;
                    }

                    details = { 
                        mainFormula: formulaText, 
                        sumFormula: `${formatCurrency(totalPerUnit)} x ${qty} ชุด = ${formatCurrency(totalPerUnit * qty)}` 
                    };
                } else if (calcMode === 'aluminum') {
                    if (!w_cm || !h_cm) return setErrorMsg('กรุณากรอกข้อมูลให้ครบถ้วน');
                    if (alumSystem === 'wood_pattern') {
                        const w_m = w_cm / 100; const h_m = h_cm / 100; const unitPrice = w_m * h_m * config.aluminumWoodPrice; 
                        price = unitPrice; 
                        totalPerUnit = unitPrice + installCost; // Add Install Cost
                        typeName = 'มู่ลี่อลูมิเนียม (ลายไม้)';
                        
                        let formulaText = `${w_m.toFixed(2)}m x ${h_m.toFixed(2)}m x ${config.aluminumWoodPrice} = ${formatCurrency(unitPrice)}`;
                        if (installCost > 0) {
                            formulaText += ` + ติดตั้ง ${formatCurrency(installCost)} = ${formatCurrency(totalPerUnit)}`;
                        }

                        details = { 
                            mainFormula: formulaText, 
                            sumFormula: `${formatCurrency(totalPerUnit)} x ${qty} ชุด = ${formatCurrency(totalPerUnit * qty)}` 
                        };
                    } else {
                        if (!aluminumPrices || !aluminumPrices.table) return setErrorMsg('ไม่พบข้อมูลราคา (กรุณาอัปโหลดไฟล์ CSV)');
                        const roundedW = roundToStep(w_cm); const roundedH = roundToStep(h_cm);
                        let basePrice = aluminumPrices.table[roundedH]?.[roundedW] || 0;
                        if (!basePrice) return setErrorMsg(`ไม่พบราคาสำหรับขนาด ${roundedW}x${roundedH} (ปัดเศษแล้ว)`);
                        let netPrice = alumSystem === 'standard' ? (basePrice * 0.40 * 0.95) : (basePrice * 0.40);
                        let discountInfo = alumSystem === 'standard' ? "ลด 60% + 5%" : "ลด 60%";
                        typeName = `มู่ลี่อลูมิเนียม (${alumSystem === 'standard' ? 'ระบบธรรมดา' : 'ระบบโซ่วน'})`;
                        price = netPrice; 
                        totalPerUnit = netPrice + installCost; // Add Install Cost
                        
                        let mainFormulaText = `ขนาด ${w_cm}x${h_cm} => ปัดเป็น ${roundedW}x${roundedH} = ${formatCurrency(basePrice)}`;
                        if (installCost > 0) {
                             mainFormulaText += ` (สุทธิ ${formatCurrency(netPrice)} + ติดตั้ง ${formatCurrency(installCost)})`;
                        }

                        details = { 
                            mainFormula: mainFormulaText, 
                            sumFormula: `ราคาตาราง ${formatCurrency(basePrice)} (${discountInfo}) = ${formatCurrency(netPrice)} ${installCost > 0 ? `+ ค่าติดตั้ง ${formatCurrency(installCost)}` : ''} = ${formatCurrency(totalPerUnit)}` 
                        };
                    }
                } else {
                    if (!w_cm || !h_cm) return setErrorMsg('กรุณากรอกข้อมูลให้ครบถ้วน');

                    const w_m = w_cm / 100;
                    const h_m = h_cm / 100;

                    let pricing_w_m = w_m;
                    let pricing_h_m = h_m;
                    let formulaExtra = "";
                    let finalArea = 0;

                    const baseFactor = calcMode === 'wooden' ? 1.2 : config.fabricFactor;

                    if (calcMode === 'wooden') {
                         price = (formData.woodType === 'BASSWOOD' ? config.basswoodPrice : config.fauxwoodPrice);
                         // Minimum Size Logic: 80x100 cm
                         if (w_cm < 80) { pricing_w_m = 0.80; formulaExtra += " (ขั้นต่ำ ก. 0.80)"; }
                         if (h_cm < 100) { pricing_h_m = 1.00; formulaExtra += " (ขั้นต่ำ ส. 1.00)"; }
                         finalArea = pricing_w_m * pricing_h_m * baseFactor;
                    } else {
                         // Roller Blinds (External/Internal) Logic
                         price = parseFloat(formData.price);
                         
                         // Calculate raw area with factor (default 1.2)
                         let calculatedArea = w_m * h_m * baseFactor;
                         
                         // Minimum Area Logic: 1.20 sq.yards
                         if (calculatedArea < 1.2) {
                             finalArea = 1.2;
                             formulaExtra += " (ขั้นต่ำ 1.20 ตร.ล.)";
                         } else {
                             finalArea = calculatedArea;
                         }
                    }

                    if (!price) return setErrorMsg('กรุณากรอกราคา');

                    // Calculate Fabric Cost using the Final Area
                    const fabricCostPerUnit = finalArea * price; 
                    
                    // Generate Details String
                    if (calcMode === 'wooden') {
                        details = { mainFormula: `${pricing_w_m.toFixed(2)} * ${pricing_h_m.toFixed(2)} * ${baseFactor} * ${price} = ${fabricCostPerUnit.toFixed(2)}${formulaExtra}` };
                    } else {
                        // Roller Blind Details
                        details = { mainFormula: `${w_m.toFixed(2)}m * ${h_m.toFixed(2)}m * ${baseFactor} = ${finalArea.toFixed(3)} ตร.ล. * ${price} = ${fabricCostPerUnit.toFixed(2)}${formulaExtra}` };
                    }
                    
                    if (calcMode === 'external') {
                        const hw = config.hardwarePrice; 
                        // For External, usually w_m/h_m (actual) is used for hardware. 
                        const top = config.topRailPrice * w_m; 
                        const bot = config.bottomRailPrice * w_m; 
                        const sling = config.slingPrice * h_m;
                        totalPerUnit = fabricCostPerUnit + hw + top + bot + sling;
                        
                        // Add Install Cost
                        totalPerUnit += installCost;

                        let sumFormulaText = `${fabricCostPerUnit.toFixed(1)} + ${hw} + ${top.toFixed(0)} + ${bot.toFixed(0)} + ${sling.toFixed(1)}`;
                        if (installCost > 0) sumFormulaText += ` + ${installCost} (ติดตั้ง)`;
                        sumFormulaText += ` = ${totalPerUnit.toFixed(1)}`;

                        details = { 
                            fabricFormula: details.mainFormula, 
                            topRailFormula: `${config.topRailPrice} * ${w_m.toFixed(2)} = ${top.toFixed(2)}`, 
                            bottomRailFormula: `${config.bottomRailPrice} * ${w_m.toFixed(2)} = ${bot.toFixed(2)}`, 
                            slingFormula: `${config.slingPrice} * ${h_m.toFixed(2)} = ${sling.toFixed(2)}`, 
                            hardwarePrice: hw, 
                            sumFormula: sumFormulaText 
                        };
                        typeName = 'ม่านม้วนภายนอก';
                    } else if (calcMode === 'internal') {
                        typeName = 'ม่านม้วนภายใน';
                        totalPerUnit = fabricCostPerUnit + installCost; // Add Install Cost
                        if (installCost > 0) {
                            details.mainFormula += ` + ค่าติดตั้ง ${formatCurrency(installCost)} = ${formatCurrency(totalPerUnit)}`;
                        }
                    } else {
                        typeName = `มู่ลี่ไม้ (${formData.woodType})`;
                        totalPerUnit = fabricCostPerUnit + installCost; // Add Install Cost
                        if (installCost > 0) {
                            details.mainFormula += ` + ค่าติดตั้ง ${formatCurrency(installCost)} = ${formatCurrency(totalPerUnit)}`;
                        }
                    }
                }

                // Store all raw parameters to enable editing later
                const rawParams = {
                    calcMode, alumSystem, pvcType, pvcOpenType, pvcCustomPrice, railType, 
                    formData: { ...formData }, // Clone to avoid ref issues
                    useInstallFee, installFee
                };

                const newItem = { 
                    id: editingId || generateId(), // Use existing ID if editing
                    w_cm, h_cm, w_m: w_cm/100, h_m: h_cm/100, unitPrice: price, qty, 
                    side: formData.side, type: calcMode, typeName, totalPerUnit, 
                    grandTotal: totalPerUnit * qty, details,
                    rawParams // Save the state
                };

                if (editingId) {
                    // Update existing item
                    setItems(items.map(item => item.id === editingId ? newItem : item));
                    // Reset editing state
                    setEditingId(null);
                } else {
                    // Add new item
                    setItems([...items, newItem]);
                }
                
                // Reset form slightly differently if editing or adding
                setFormData(prev => ({ ...prev, width: '', height: '' }));
                setUseInstallFee(false); setInstallFee(''); 
                if(calcMode === 'pvc') setPvcCustomPrice('');
            };

            const saveToHistory = async () => {
                if (!user) return onLogin();
                if (items.length === 0) return alert("ไม่มีรายการให้บันทึก");
                const name = prompt("ตั้งชื่อใบเสนอราคา:");
                if (!name) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('quotations').add({ name, items, total: items.reduce((a,b)=>a+b.grandTotal,0), createdAt: new Date().toISOString() });
                    alert("บันทึกเรียบร้อย!");
                } catch(e) { alert("บันทึกไม่สำเร็จ: " + e.message); }
            };

            return (
                <div className="pt-24 px-5 pb-40 fade-in">
                    <div className="flex justify-between items-center mb-6"><h2 className={`text-2xl font-bold ${theme.textMain}`}>คำนวณราคา</h2>{items.length > 0 && <button onClick={saveToHistory} className={`text-xs font-bold px-4 py-2 rounded-xl flex gap-2 items-center shadow-sm hover:shadow-md transition-all active:scale-95 hover:-translate-y-0.5 ${theme.btnSecondary}`}><Icons.Save size={16}/> บันทึก</button>}</div>
                    {availableModes.length > 0 ? (
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            {availableModes.map(mode => (<button key={mode.id} onClick={() => { setCalcMode(mode.id); setEditingId(null); }} className={`bento-card relative overflow-hidden rounded-2xl p-3 flex flex-col items-center justify-center gap-2 h-auto py-2 border ${calcMode === mode.id ? `bg-white shadow-lg ring-1 ${theme.inputRing}` : 'bg-white border-white shadow-sm hover:shadow-md'}`}><div className={`p-1.5 rounded-full transition-colors ${calcMode === mode.id ? `${theme.bgSoft} ${theme.primary}` : `bg-slate-50 text-slate-400 group-hover:text-slate-600`}`}>{mode.icon}</div><span className={`text-[11px] font-bold transition-colors ${calcMode === mode.id ? theme.primary : theme.textSub}`}>{mode.label}</span>{calcMode === mode.id && <div className={`absolute inset-x-0 bottom-0 h-1 ${theme.toggleActive}`}></div>}</button>))}
                        </div>
                    ) : <div className="bg-white p-6 rounded-2xl text-center text-slate-400 border border-dashed border-slate-300 mb-6 font-bold">ปิดปรับปรุงระบบคำนวณชั่วคราว</div>}
                    {availableModes.length > 0 && (
                        <div className={`bg-white rounded-[2rem] shadow-[0_20px_40px_-15px_rgba(0,0,0,0.05)] border border-white p-6 mb-6 relative overflow-hidden scale-in ${editingId ? 'ring-2 ring-orange-400' : ''}`}>
                            {editingId && <div className="mb-4 text-xs font-bold text-orange-500 flex items-center gap-2 bg-orange-50 p-2 rounded-lg"><Icons.Edit size={14}/> กำลังแก้ไขรายการ</div>}
                            
                            {calcMode === 'rail' && (<div className="mb-6 space-y-4"><div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>ประเภทราง</label><select value={railType} onChange={(e) => setRailType(e.target.value)} className={`input-apple w-full bg-white border ${theme.border} rounded-xl p-3 font-bold text-slate-700`}>{railOptions.map(r => (<option key={r.id} value={r.id}>{r.label} ({r.price}/{r.unit})</option>))}</select></div></div>)}
                            {calcMode === 'pvc' && (<div className="mb-6 space-y-4"><div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>ประเภทใบ/ราคา</label><select value={pvcType} onChange={(e) => setPvcType(e.target.value)} className={`input-apple w-full bg-white border ${theme.border} rounded-xl p-3 font-bold text-slate-700`}>{pvcPriceOptions.map(p => (<option key={p.id} value={p.id}>{p.label} {p.price !== 'manual' ? `(${p.price})` : ''}</option>))}</select></div>{(pvcPriceOptions.find(p => p.id === pvcType)?.price === 'manual') && (<div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>ระบุราคา (บาท/ตร.ล.)</label><input type="number" value={pvcCustomPrice} onChange={(e) => setPvcCustomPrice(e.target.value)} className={`input-apple w-full bg-white border ${theme.border} rounded-xl p-3 font-bold text-xl text-slate-700`} placeholder="ระบุราคา..." /></div>)}<div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>รูปแบบการเปิด</label><select value={pvcOpenType} onChange={(e) => setPvcOpenType(e.target.value)} className={`input-apple w-full bg-white border ${theme.border} rounded-xl p-3 font-bold text-slate-700`}>{pvcOpeningOptions.map(o => <option key={o.id} value={o.id}>{o.label}</option>)}</select></div></div>)}
                            {calcMode === 'aluminum' && (<div className="mb-6"><label className={`text-xs font-bold uppercase tracking-wider mb-3 block ml-1 ${theme.textSub}`}>เลือกระบบ</label><div className={`flex flex-col gap-2`}><div className="flex gap-2"><button onClick={() => setAlumSystem('standard')} className={`flex-1 py-3 rounded-xl border font-bold text-sm transition-all ${alumSystem === 'standard' ? `${theme.border} ${theme.bgSoft} ${theme.primary} shadow-sm` : 'border-slate-100 text-slate-400 hover:border-slate-300'}`}>ธรรมดา (ลด 60%+5%)</button><button onClick={() => setAlumSystem('chain')} className={`flex-1 py-3 rounded-xl border font-bold text-sm transition-all ${alumSystem === 'chain' ? `${theme.border} ${theme.bgSoft} ${theme.primary} shadow-sm` : 'border-slate-100 text-slate-400 hover:border-slate-300'}`}>โซ่วน (ลด 60%)</button></div><button onClick={() => setAlumSystem('wood_pattern')} className={`w-full py-3 rounded-xl border font-bold text-sm transition-all ${alumSystem === 'wood_pattern' ? `${theme.border} ${theme.bgSoft} ${theme.primary} shadow-sm` : 'border-slate-100 text-slate-400 hover:border-slate-300'}`}>ลายไม้ (ตร.ม. ละ {config.aluminumWoodPrice})</button></div></div>)}
                            {calcMode === 'wooden' && (<div className="mb-6"><label className={`text-xs font-bold uppercase tracking-wider mb-3 block ml-1 ${theme.textSub}`}>ชนิดไม้</label><div className={`flex gap-3 p-1.5 rounded-xl ${theme.bgSoft}`}>{['BASSWOOD', 'FAUX WOOD'].map(t => (<label key={t} className={`flex-1 cursor-pointer rounded-lg py-2.5 flex items-center justify-center transition-all ${formData.woodType === t ? 'bg-white shadow-sm font-bold' : 'font-medium opacity-60'} ${theme.textMain}`}><input type="radio" name="woodType" value={t} checked={formData.woodType === t} onChange={handleInputChange} className="hidden" /><span className="text-xs">{t}</span></label>))}</div></div>)}
                            
                            <div className="grid grid-cols-2 gap-4 mb-5"><div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>กว้าง (cm)</label><input type="number" name="width" value={formData.width} onChange={handleInputChange} className={`input-apple w-full bg-white border ${theme.border} rounded-xl p-4 font-bold text-xl ${theme.textMain} transition-all placeholder-slate-300 ${calcMode === 'rail' && railType === 'ceiling_bracket' ? 'opacity-50' : ''}`} placeholder="0" /></div><div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>สูง (cm) <span className="font-normal text-gray-300">(ถ้ามี)</span></label><input type="number" name="height" value={formData.height} onChange={handleInputChange} className={`input-apple w-full bg-white border ${theme.border} rounded-xl p-4 font-bold text-xl ${theme.textMain} transition-all placeholder-slate-300`} placeholder="0" /></div></div>
                            <div className="grid grid-cols-2 gap-4 mb-6">{calcMode !== 'aluminum' && calcMode !== 'pvc' && calcMode !== 'rail' && (calcMode !== 'wooden' ? (<div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>ราคาผ้า</label><input type="number" name="price" value={formData.price} onChange={handleInputChange} className={`input-apple w-full bg-white border ${theme.border} rounded-xl p-4 font-bold text-xl ${theme.textMain} transition-all placeholder-slate-300`} placeholder="฿" /></div>) : (<div><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>ราคา/หน่วย</label><div className={`w-full ${theme.bgSoft} border border-transparent rounded-xl p-4 font-bold text-xl flex items-center ${theme.textSub}`}>{formatCurrency(formData.woodType === 'BASSWOOD' ? config.basswoodPrice : config.fauxwoodPrice)}</div></div>))}<div className={(calcMode === 'aluminum' || calcMode === 'pvc' || calcMode === 'rail') ? 'col-span-2' : ''}><label className={`text-xs font-bold uppercase tracking-wider mb-2 block ml-1 ${theme.textSub}`}>จำนวน</label><div className={`flex bg-white border ${theme.border} rounded-xl overflow-hidden h-[62px]`}><button onClick={() => setFormData(p => ({...p, qty: Math.max(1, parseInt(p.qty)-1 || 1).toString()}))} className={`px-5 font-bold text-xl transition-colors hover:bg-slate-50 ${theme.textSub}`}>-</button><input type="number" name="qty" value={formData.qty} onChange={handleInputChange} className={`w-full bg-transparent text-center font-bold text-xl focus:outline-none ${theme.textMain}`} /><button onClick={() => setFormData(p => ({...p, qty: (parseInt(p.qty)+1 || 1).toString()}))} className={`px-5 font-bold text-xl transition-colors hover:bg-slate-50 ${theme.textSub}`}>+</button></div></div></div>
                            {calcMode !== 'pvc' && calcMode !== 'rail' && (<div className="mb-6"><label className={`text-xs font-bold uppercase tracking-wider mb-3 block ml-1 ${theme.textSub}`}>ตำแหน่งโซ่/สลิง</label><div className="flex gap-4">{['ซ้าย', 'ขวา'].map(s => (<label key={s} className={`flex-1 cursor-pointer border-2 rounded-xl py-3 flex items-center justify-center gap-2 transition-all ${formData.side === s ? `${theme.border} ${theme.bgSoft} ${theme.primary} shadow-sm` : 'border-slate-100 text-slate-400 hover:border-slate-300'}`}><input type="radio" name="side" value={s} checked={formData.side === s} onChange={handleInputChange} className="hidden" /><span className="font-bold">{s}</span></label>))}</div></div>)}
                            {calcMode === 'rail' && railType !== 'ceiling_bracket' && (<div className="mb-6"><label className={`text-xs font-bold uppercase tracking-wider mb-3 block ml-1 ${theme.textSub}`}>รูปแบบการเปิด</label><div className="flex gap-4">{['เปิดกลาง', 'เปิดข้าง'].map(s => (<label key={s} className={`flex-1 cursor-pointer border-2 rounded-xl py-3 flex items-center justify-center gap-2 transition-all ${formData.side === s ? `${theme.border} ${theme.bgSoft} ${theme.primary} shadow-sm` : 'border-slate-100 text-slate-400 hover:border-slate-300'}`}><input type="radio" name="side" value={s} checked={formData.side === s} onChange={handleInputChange} className="hidden" /><span className="font-bold">{s}</span></label>))}</div></div>)}
                            
                            {/* --- NEW: Installation Fee Toggle --- */}
                            <div className={`mb-8 p-4 rounded-xl border border-slate-100 bg-slate-50 transition-all ${useInstallFee ? 'ring-1 ring-orange-100' : ''}`}>
                                <label className={`flex items-center gap-3 cursor-pointer ${theme.textMain} select-none`}>
                                    <div className={`w-6 h-6 rounded-md border flex items-center justify-center transition-colors ${useInstallFee ? 'bg-orange-500 border-orange-500' : 'bg-white border-slate-300'}`}>
                                        {useInstallFee && <Icon path={<polyline points="20 6 9 17 4 12"></polyline>} size={16} className="text-white stroke-2" />}
                                        <input type="checkbox" checked={useInstallFee} onChange={(e) => setUseInstallFee(e.target.checked)} className="hidden" />
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <Icons.Wrench size={18} className={useInstallFee ? 'text-orange-500' : 'text-slate-400'} />
                                        <span className={`font-bold text-sm ${useInstallFee ? 'text-slate-700' : 'text-slate-500'}`}>รวมค่าบริการติดตั้ง</span>
                                    </div>
                                </label>
                                {useInstallFee && (
                                    <div className="mt-3 animate-scale-in">
                                        <div className="flex items-center justify-between mb-1.5 ml-1">
                                            <label className="text-xs font-bold text-slate-400">ค่าติดตั้ง (ต่อชุด)</label>
                                        </div>
                                        <input
                                            type="number"
                                            value={installFee}
                                            onChange={(e) => setInstallFee(e.target.value)}
                                            className={`input-apple w-full bg-white border border-slate-200 rounded-xl p-3 font-bold text-slate-700 ${theme.inputRing} placeholder-slate-300`}
                                            placeholder="ระบุราคา..."
                                            autoFocus
                                        />
                                    </div>
                                )}
                            </div>

                            {errorMsg && <div className="mb-6 p-4 bg-red-50 text-red-600 text-sm font-bold rounded-2xl flex items-center gap-3 animate-pulse border border-red-100"><Icons.AlertCircle size={20} /> {errorMsg}</div>}
                            
                            <div className="flex gap-3">
                                {editingId && (
                                    <button onClick={cancelEdit} className={`flex-1 font-bold text-lg py-4 rounded-2xl border border-slate-200 text-slate-500 active:scale-95 transition-all flex justify-center items-center gap-2 hover:bg-slate-50`}>
                                        ยกเลิก
                                    </button>
                                )}
                                <button onClick={calculateItem} className={`flex-[2] font-bold text-lg py-4 rounded-2xl shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 hover:-translate-y-1 ${editingId ? 'bg-orange-500 text-white shadow-orange-200 hover:bg-orange-600' : theme.btnPrimary}`}>
                                    {editingId ? <><Icons.CheckCircle size={24} /> บันทึกการแก้ไข</> : <><Icons.Plus size={24} /> เพิ่มรายการ</>}
                                </button>
                            </div>
                        </div>
                    )}
                    {items.length > 0 && (<div className="space-y-4 pb-20"><div className="flex justify-between items-center px-4"><span className={`text-sm font-bold uppercase tracking-wider ${theme.textSub}`}>รายการ ({items.length})</span><button onClick={() => setItems([])} className={`text-xs font-bold px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 ${theme.btnSecondary}`}><Icons.Trash2 size={14}/> ล้าง</button></div>{items.map((item) => (<div key={item.id} className={`bg-white p-5 rounded-2xl border border-white shadow-[0_4px_20px_-10px_rgba(0,0,0,0.08)] relative group scale-in hover:scale-[1.02] transition-transform ${editingId === item.id ? 'ring-2 ring-orange-400 opacity-50' : ''}`}><div className="absolute top-4 right-4 flex gap-2"><button onClick={() => handleEdit(item)} disabled={!!editingId} className={`p-2 rounded-full transition-colors ${theme.textSub} hover:text-orange-500 hover:bg-orange-50 disabled:opacity-30`}><Icons.Edit size={18} /></button><button onClick={() => setItems(prev => prev.filter(i => i.id !== item.id))} disabled={!!editingId} className={`p-2 rounded-full transition-colors ${theme.textSub} hover:${theme.primary} hover:${theme.bgSoft} disabled:opacity-30`}><Icons.X size={18} /></button></div><div className="flex items-center gap-3 mb-4"><div className={`p-2 rounded-xl ${theme.bgSoft} ${theme.primary}`}>{item.type === 'external' ? <Icons.Sun size={18} /> : item.type === 'wooden' ? <Icons.Blinds size={18} /> : item.type === 'aluminum' ? <Icons.Blinds size={18} /> : item.type === 'pvc' ? <Icons.Fold size={18} /> : item.type === 'rail' ? <Icon path={<line x1="2" y1="12" x2="22" y2="12"></line>} size={18} /> : <Icons.Roller size={18} />}</div><span className={`text-sm font-bold ${theme.textMain}`}>{item.typeName}</span></div><div className="flex justify-between items-end"><div><div className={`text-lg font-bold font-mono tracking-tight ${theme.textMain}`}>{item.w_cm || '-'} <span className="text-slate-400 text-sm">x</span> {item.h_cm || '-'} <span className="text-xs text-slate-400 font-sans">cm</span></div><div className={`text-xs font-medium mt-1 inline-block px-2 py-1 rounded-md border border-slate-100 ${theme.textSub} ${theme.bgSoft}`}>จำนวน {item.qty} ชุด • ปรับ{item.side}</div></div><div className={`text-xl font-bold ${theme.highlight}`}>{formatCurrency(item.grandTotal)}</div></div></div>))}<button onClick={() => setShowQuote(true)} className={`w-full px-6 py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 font-bold text-lg active:scale-95 transition-all mt-4 hover:-translate-y-1 ${theme.btnPrimary}`}><Icons.FileText size={24} /> สรุปราคา {formatCurrency(items.reduce((a,b) => a+b.grandTotal, 0))}</button></div>)}
                    {showQuote && <QuotationModal items={items} onClose={() => setShowQuote(false)} config={config} userProfile={userProfile} theme={theme} />}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [showAdmin, setShowAdmin] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const [isAdminLoggedIn, setIsAdminLoggedIn] = useState(false);
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null); 
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [items, setItems] = useState([]);
            const [aluminumPrices, setAluminumPrices] = useState(null);

            const currentTheme = THEMES[config.theme] || THEMES.default;
            
            useEffect(() => { document.body.style.backgroundColor = config.theme === 'apple' ? '#F5F5F7' : '#f8fafc'; }, [config.theme]);
            
            useEffect(() => {
                const manifest = {
                    name: "SUNNY Blind System",
                    short_name: "SUNNY Blinds",
                    start_url: window.location.href,
                    display: "standalone",
                    background_color: "#ffffff",
                    theme_color: "#ffffff",
                    icons: [
                        { src: "https://img2.pic.in.th/SUNNY-LOGO54c76f9eedf06c96.png", sizes: "192x192", type: "image/png" },
                        { src: "https://img2.pic.in.th/SUNNY-LOGO54c76f9eedf06c96.png", sizes: "512x512", type: "image/png" }
                    ]
                };
                const stringManifest = JSON.stringify(manifest);
                const blob = new Blob([stringManifest], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(blob);
                const linkTag = document.getElementById('manifest-placeholder');
                if(linkTag) linkTag.setAttribute('href', manifestURL);

                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault(); 
                    setDeferredPrompt(e);
                    console.log("พร้อมติดตั้งแอปแล้ว");
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);
            
            const handleInstallApp = async () => { 
                if (deferredPrompt) { 
                    deferredPrompt.prompt(); 
                    const { outcome } = await deferredPrompt.userChoice; 
                    if (outcome === 'accepted') {
                        setDeferredPrompt(null);
                    }
                } else { 
                    alert('หากไม่มีหน้าต่างเด้งขึ้นมา:\n- Android: กดเมนูสามจุดมุมขวาบน > "ติดตั้งแอป" หรือ "เพิ่มลงในหน้าจอหลัก"\n- iOS: กดปุ่ม Share (แชร์) ด้านล่าง > เลือก "เพิ่มไปยังหน้าจอโฮม" (Add to Home Screen)\n- PC: กดไอคอนติดตั้งที่ด้านขวาของแถบ URL'); 
                } 
            };

            const handleLogin = async () => { if (!auth) return alert("ระบบยังไม่พร้อมใช้งาน"); try { const provider = new firebase.auth.GoogleAuthProvider(); await auth.signInWithPopup(provider); } catch (error) { console.error(error); alert("เข้าสู่ระบบล้มเหลว: " + error.message); } };
            const handleLogout = async () => { if (confirm("ต้องการออกจากระบบ?")) { await auth.signOut(); setShowProfile(false); setItems([]); } };

            useEffect(() => {
                const loadLocal = () => { const saved = localStorage.getItem('blindAppConfig'); if (saved) try { setConfig({ ...DEFAULT_CONFIG, ...JSON.parse(saved) }); } catch(e){} };
                if (!auth || !db) { loadLocal(); return; }
                const unsubscribeAuth = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        setIsFirebaseReady(true);
                        const configRef = db.doc(`artifacts/${appId}/public/data/config/main`);
                        configRef.onSnapshot((docSnap) => { if (docSnap.exists) setConfig({ ...DEFAULT_CONFIG, ...docSnap.data() }); else configRef.set(DEFAULT_CONFIG).catch(console.error); }, () => loadLocal());
                        const profileRef = db.doc(`artifacts/${appId}/users/${currentUser.uid}/profile/info`);
                        profileRef.onSnapshot(doc => { setUserProfile(doc.exists ? doc.data() : null); });
                        const aluminumRef = db.doc(`artifacts/${appId}/public/data/price_tables/aluminum`);
                        aluminumRef.onSnapshot(doc => { if(doc.exists) setAluminumPrices(doc.data()); });
                    } else { loadLocal(); setUserProfile(null); }
                });
                return () => unsubscribeAuth();
            }, []);

            const saveConfig = async (newConfig) => { setConfig(newConfig); if (db && user) { try { await db.doc(`artifacts/${appId}/public/data/config/main`).set(newConfig); } catch (e) { alert('บันทึกออนไลน์ไม่สำเร็จ บันทึกในเครื่องแทน'); localStorage.setItem('blindAppConfig', JSON.stringify(newConfig)); } } else { localStorage.setItem('blindAppConfig', JSON.stringify(newConfig)); alert('บันทึกในเครื่องเรียบร้อย (โหมดออฟไลน์)'); } };
            const saveAluminumTable = async (data) => { if (db && user) { try { await db.doc(`artifacts/${appId}/public/data/price_tables/aluminum`).set(data); alert('บันทึกตารางราคาเรียบร้อย'); } catch (e) { alert("บันทึกตารางราคาไม่สำเร็จ: " + e.message); } } else { alert("กรุณาเข้าสู่ระบบก่อนบันทึก"); } }
            const saveUserProfile = async (newProfile) => { if (db && user) { try { await db.doc(`artifacts/${appId}/users/${user.uid}/profile/info`).set(newProfile, { merge: true }); alert("บันทึกข้อมูลโปรไฟล์เรียบร้อย"); } catch (e) { alert("บันทึกโปรไฟล์ไม่สำเร็จ: " + e.message); } } };
            const loadQuotation = (savedItems) => { setItems(savedItems); setShowProfile(false); setActiveTab('calculator'); };

            return (
                <div className={`min-h-screen pb-24 ${currentTheme.textMain}`}>
                    <div className={`max-w-md mx-auto min-h-screen relative ${currentTheme.bgApp} sm:shadow-2xl sm:my-4 sm:rounded-[40px] sm:min-h-[calc(100vh-2rem)] overflow-hidden border border-white/50 transition-colors duration-500`}>
                        <div className={`h-16 w-full absolute top-0 z-30 flex justify-between items-center px-6 sticky ${config.theme === 'apple' ? 'glass' : 'bg-white/95 backdrop-blur-sm shadow-sm'}`}><div className="flex items-center gap-2">{activeTab !== 'home' && (<img src={config.logoUrl} alt="Logo" className="h-14 w-auto object-contain drop-shadow-sm fade-in" style={{filter: currentTheme.logoFilter}} onError={(e) => e.target.style.display = 'none'} />)}</div><div className="flex items-center gap-3">{user ? (<button className="flex items-center gap-2 focus:outline-none hover:scale-105 transition-transform" onClick={() => setShowProfile(true)}><img src={userProfile?.photoURL || user.photoURL} className="w-9 h-9 rounded-full border-2 border-white shadow-sm" alt="User" /></button>) : (<button onClick={handleLogin} className={`flex items-center gap-2 text-sm font-bold bg-white px-5 py-2.5 rounded-full shadow-md hover:shadow-lg transition-all active:scale-95 border ${currentTheme.border}`}><Icons.Google size={28} className="text-red-600" /> <span className={currentTheme.textMain}>เข้าสู่ระบบด้วย Gmail</span></button>)}</div></div>
                        {activeTab === 'home' && <HomePage setActiveTab={setActiveTab} config={config} onInstall={handleInstallApp} theme={currentTheme} />}
                        {activeTab === 'stock' && <StockPage theme={currentTheme} />}
                        {activeTab === 'calculator' && <CalculatorPage config={config} items={items} setItems={setItems} user={user} onLogin={handleLogin} userProfile={userProfile} theme={currentTheme} aluminumPrices={aluminumPrices} />}
                        <div className={`fixed bottom-6 left-1/2 -translate-x-1/2 w-[calc(100%-3rem)] max-w-[380px] rounded-3xl p-2 flex justify-around items-center z-50 ${config.theme === 'apple' ? 'glass-panel' : 'bg-white/90 backdrop-blur-lg shadow-lg border border-gray-100'}`}><NavButton active={activeTab === 'home'} onClick={() => setActiveTab('home')} icon={<Icons.Home size={24} />} label="หน้าหลัก" theme={currentTheme} /><NavButton active={activeTab === 'stock'} onClick={() => setActiveTab('stock')} icon={<Icons.Box size={24} />} label="สต็อก" theme={currentTheme} /><NavButton active={activeTab === 'calculator'} onClick={() => setActiveTab('calculator')} icon={<Icons.Calculator size={24} />} label="คำนวณ" theme={currentTheme} /><NavButton active={showAdmin} onClick={() => setShowAdmin(true)} icon={<Icons.Settings size={24} />} label="ตั้งค่า" theme={currentTheme} /></div>
                        {showAdmin && (<AdminModal isOpen={showAdmin} onClose={() => setShowAdmin(false)} isLoggedIn={isAdminLoggedIn} setLoggedIn={setIsAdminLoggedIn} config={config} onSave={saveConfig} theme={currentTheme} onSaveAluminum={saveAluminumTable} aluminumPrices={aluminumPrices} />)}
                        {showProfile && user && (<ProfileModal user={user} userProfile={userProfile} onClose={() => setShowProfile(false)} onLogout={handleLogout} onLoad={loadQuotation} onSaveProfile={saveUserProfile} theme={currentTheme} />)}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script src="/_vercel/insights/script.js"></script>
</body>
</html>
