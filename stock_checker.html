<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Checker</title>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #ea580c; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const StockChecker = () => {
            const [searchQuery, setSearchQuery] = useState('');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchResult, setSearchResult] = useState(null);
            const [error, setError] = useState('');
            const [showDebug, setShowDebug] = useState(false);

            const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQz2OtjzRBmeUmLOTSgJ-Bt2woZPiR9QyzvIWcBXacheG3IplefFZE66yWYE43qVRQo2DAOPu9UClh5/pub?gid=1132498145&single=true&output=csv';

            useEffect(() => {
                fetchData();
            }, []);

            // ฟังก์ชันสำหรับรวมข้อมูลบรรทัดที่ต่อเนื่องกัน
            const preprocessData = (rawData) => {
                if (!rawData || rawData.length === 0) return [];

                const processed = [];
                let currentRow = null;
                
                // คำศัพท์ที่น่าจะเป็นหัวตารางของรหัสสินค้า
                const idKeys = ['ชื่อสินค้า35MM', 'Product Name', 'ชื่อสินค้า', 'Name', 'Description', 'Code', 'รหัส'];
                
                // หา Key ที่น่าจะเป็นรหัสสินค้าจริงๆ จากข้อมูลชุดแรก
                let idKey = null;
                if (rawData.length > 0) {
                    const firstRowKeys = Object.keys(rawData[0]);
                    idKey = firstRowKeys.find(k => {
                        const norm = k.replace(/[^a-zA-Z0-9\u0E00-\u0E7F]/g, '').toLowerCase(); 
                        return idKeys.some(idk => norm.includes(idk.toLowerCase()));
                    }) || firstRowKeys[0]; // ถ้าหาไม่เจอให้ใช้คอลัมน์แรก
                }

                rawData.forEach(row => {
                    // ตรวจสอบว่ามีรหัสสินค้าหรือไม่
                    const idValue = row[idKey];
                    const hasId = idValue && String(idValue).trim().length > 0;

                    if (hasId) {
                        // เจอสินค้าใหม่: สร้าง Object ใหม่และบันทึก
                        currentRow = { ...row }; 
                        processed.push(currentRow);
                    } else if (currentRow) {
                        // ไม่เจอชื่อสินค้า แต่มีบรรทัดก่อนหน้า: ถือว่าเป็นตัวต่อ (Continuation)
                        // ให้วนลูปทุกคอลัมน์เพื่อรวมตัวเลข
                        Object.keys(row).forEach(key => {
                            if (key === idKey) return; // ข้ามช่องชื่อ

                            // แปลงค่าเป็นตัวเลข (ตัด comma ออกถ้ามี)
                            const valStr = String(row[key] || '').replace(/,/g, '').trim();
                            const currentStr = String(currentRow[key] || '').replace(/,/g, '').trim();
                            
                            // เช็คว่าเป็นตัวเลขหรือไม่ (ต้องเป็นตัวเลขล้วนๆ)
                            if (valStr && !isNaN(Number(valStr))) {
                                const val = parseFloat(valStr);
                                const currentVal = (currentStr && !isNaN(Number(currentStr))) ? parseFloat(currentStr) : 0;
                                
                                // รวมยอดเข้ากับบรรทัดหลัก (currentRow)
                                currentRow[key] = String(currentVal + val);
                            }
                        });
                    }
                });
                
                console.log("Processed Data Rows:", processed.length); // Debug
                return processed;
            };

            const fetchData = () => {
                setLoading(true);
                Papa.parse(SHEET_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        console.log("Raw Headers found:", results.meta.fields);
                        // เรียกใช้ฟังก์ชันรวมร่างข้อมูลก่อนนำไปเก็บใน State
                        const mergedData = preprocessData(results.data);
                        setData(mergedData);
                        setLoading(false);
                    },
                    error: (err) => {
                        console.error(err);
                        setError('ไม่สามารถดึงข้อมูลสต็อกได้ กรุณาลองใหม่');
                        setLoading(false);
                    }
                });
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if (!searchQuery.trim()) return;

                const query = searchQuery.trim().toLowerCase();
                
                // ค้นหาจากข้อมูลที่ถูกรวมร่างแล้ว (mergedData)
                const found = data.find(row => {
                     // ค้นหาในทุกคอลัมน์ว่ามีคำค้นหาหรือไม่
                    return Object.values(row).some(val => val && val.toString().toLowerCase().includes(query));
                });

                if (found) {
                    setSearchResult(found);
                    setError('');
                } else {
                    setSearchResult(null);
                    setError(`ไม่พบรหัสสินค้า: ${searchQuery}`);
                }
            };

            // Mapping หัวตาราง
            const displayColumns = [
                { label: 'ชื่อสินค้า', keys: ['ชื่อสินค้า35MM', 'Product Name', 'ชื่อสินค้า', 'Name', 'Description'] },
                { label: '4.0 ฟุต', keys: ['ใบ 4ft', '4ft', '4 ft', '4.0', '4', '4\'', 'Size 4', '4.00'] },
                { label: '4.5 ฟุต', keys: ['ใบ 4.5ft', '4.5ft', '4.5 ft', '4.5', '4.5\'', 'Size 4.5', '4.50'] },
                { label: '5.0 ฟุต', keys: ['ใบ 5ft', '5ft', '5 ft', '5.0', '5', '5\'', 'Size 5', '5.00'] },
                { label: '5.5 ฟุต', keys: ['ใบ 5.5ft', '5.5ft', '5.5 ft', '5.5', '5.5\'', 'Size 5.5', '5.50'] },
                { label: '6.0 ฟุต', keys: ['ใบ 6ft', '6ft', '6 ft', '6.0', '6', '6\'', 'Size 6', '6.00'] },
                { label: '6.5 ฟุต', keys: ['ใบ 6.5ft', '6.5ft', '6.5 ft', '6.5', '6.5\'', 'Size 6.5', '6.50'] },
                { label: '7.0 ฟุต', keys: ['ใบ 7ft', '7ft', '7 ft', '7.0', '7', '7\'', 'Size 7', '7.00'] },
                { label: '8.0 ฟุต', keys: ['ใบ 8ft', '8ft', '8 ft', '8.0', '8', '8\'', 'Size 8', '8.00'] },
            ];

            const getValue = (row, possibleKeys) => {
                if (!row) return '-';
                const rowKeys = Object.keys(row);
                
                for (let targetKey of possibleKeys) {
                    // 1. หาตรงๆ
                    if (row[targetKey] !== undefined && row[targetKey] !== "") return row[targetKey];

                    // 2. หาแบบตัดช่องว่าง (Fuzzy match)
                    const normalizedTarget = targetKey.replace(/[^a-zA-Z0-9.]/g, '').toLowerCase();
                    const foundKey = rowKeys.find(k => {
                        const normalizedK = k.replace(/[^a-zA-Z0-9.]/g, '').toLowerCase();
                        return normalizedK === normalizedTarget;
                    });
                    
                    if (foundKey && row[foundKey] !== undefined && row[foundKey] !== "") return row[foundKey];
                }
                return '-';
            };

            return (
                <div className="p-4 min-h-screen bg-slate-50">
                    <div className="max-w-md mx-auto">
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6">
                            <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-orange-500"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                เช็คสต็อกมู่ลี่ไม้
                            </h2>
                            
                            <form onSubmit={handleSearch} className="relative">
                                <input 
                                    type="text" 
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    placeholder="ค้นหารหัส (เช่น B35-36)" 
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-4 pr-12 font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-orange-100 focus:border-orange-300 transition-all placeholder-slate-400"
                                />
                                <button 
                                    type="submit"
                                    className="absolute right-2 top-2 p-1.5 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors shadow-sm"
                                    disabled={loading}
                                >
                                    {loading ? <div className="loading-spinner border-white border-t-transparent w-5 h-5"></div> : <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>}
                                </button>
                            </form>
                            
                            {error && (
                                <div className="mt-4 p-3 bg-red-50 text-red-600 text-sm font-bold rounded-xl flex items-center gap-2 animate-pulse">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    {error}
                                </div>
                            )}
                        </div>

                        {searchResult && (
                            <div className="bg-white rounded-2xl shadow-lg border border-orange-100 overflow-hidden fade-in">
                                <div className="bg-orange-50 p-4 border-b border-orange-100 flex justify-between items-start">
                                    <div>
                                        <span className="text-xs font-bold text-orange-400 uppercase tracking-wider">ผลลัพธ์การค้นหา</span>
                                        <h3 className="text-xl font-bold text-slate-800 mt-1">{getValue(searchResult, ['ชื่อสินค้า35MM', 'Product Name', 'Name'])}</h3>
                                        <p className="text-sm text-slate-500 font-mono mt-0.5">{searchQuery}</p>
                                    </div>
                                    <div className="text-right">
                                       <span className="bg-white text-orange-600 text-xs font-bold px-2 py-1 rounded-md border border-orange-200">Wood (ยอดรวม)</span>
                                    </div>
                                </div>
                                <div className="divide-y divide-slate-100">
                                    {displayColumns.slice(1).map((col, index) => { 
                                        const val = getValue(searchResult, col.keys);
                                        const isAvailable = val !== '-' && val !== '0' && val !== '';
                                        return (
                                            <div key={index} className="flex justify-between items-center p-4 hover:bg-slate-50 transition-colors">
                                                <span className="text-sm text-slate-500 font-medium">{col.label}</span>
                                                <div className="flex items-center gap-2">
                                                    {isAvailable ? (
                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                            มีของ
                                                        </span>
                                                    ) : (
                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-500">
                                                            -
                                                        </span>
                                                    )}
                                                    <span className={`font-bold w-12 text-right ${isAvailable ? 'text-slate-800 text-xl' : 'text-slate-300'}`}>
                                                        {val}
                                                    </span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="p-2 bg-slate-50 text-center">
                                    <button onClick={() => setShowDebug(!showDebug)} className="text-[10px] text-slate-400 underline">
                                        {showDebug ? 'ซ่อนข้อมูลดิบ' : 'ข้อมูลไม่ขึ้น? คลิกดูข้อมูลดิบ'}
                                    </button>
                                </div>
                                {showDebug && (
                                    <div className="p-4 bg-slate-800 text-white text-xs font-mono overflow-x-auto">
                                        <p className="mb-2 font-bold text-green-400">--- Processed Data (Merged) ---</p>
                                        <pre>{JSON.stringify(searchResult, null, 2)}</pre>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {!searchResult && !loading && !error && (
                            <div className="text-center text-slate-400 mt-10 text-sm">
                                <p>กรอกรหัสสินค้าเพื่อตรวจสอบสต็อกล่าสุด</p>
                                <p className="text-xs mt-2 opacity-50">ข้อมูลจาก Google Sheets (Wood)</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockChecker />);
    </script>
</body>
</html>
